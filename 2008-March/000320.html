<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Transform-svn] r384 - in dev/dev-2-4/src/com/flagstone/transform:	. test util
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/transform-svn/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:transform-svn%40lists.berlios.de?Subject=Re%3A%20%5BTransform-svn%5D%20r384%20-%20in%20dev/dev-2-4/src/com/flagstone/transform%3A%0A%09.%20test%20util&In-Reply-To=%3C200803191218.m2JCI5UD025862%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000319.html">
   <LINK REL="Next"  HREF="000329.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Transform-svn] r384 - in dev/dev-2-4/src/com/flagstone/transform:	. test util</H1>
    <B>smackay at mail.berlios.de</B> 
    <A HREF="mailto:transform-svn%40lists.berlios.de?Subject=Re%3A%20%5BTransform-svn%5D%20r384%20-%20in%20dev/dev-2-4/src/com/flagstone/transform%3A%0A%09.%20test%20util&In-Reply-To=%3C200803191218.m2JCI5UD025862%40sheep.berlios.de%3E"
       TITLE="[Transform-svn] r384 - in dev/dev-2-4/src/com/flagstone/transform:	. test util">smackay at mail.berlios.de
       </A><BR>
    <I>Wed Mar 19 13:18:05 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000319.html">[Transform-svn] r383 - in dev/dev-2-4/src/com/flagstone/transform:	. test util
</A></li>
        <LI>Next message: <A HREF="000329.html">[Transform-svn] r385 - in dev/dev-2-4/src/com/flagstone/transform:	. test util
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#320">[ date ]</a>
              <a href="thread.html#320">[ thread ]</a>
              <a href="subject.html#320">[ subject ]</a>
              <a href="author.html#320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: smackay
Date: 2008-03-19 13:16:57 +0100 (Wed, 19 Mar 2008)
New Revision: 384

Added:
   dev/dev-2-4/src/com/flagstone/transform/FSContext.java
Modified:
   dev/dev-2-4/src/com/flagstone/transform/Codeable.java
   dev/dev-2-4/src/com/flagstone/transform/FSAction.java
   dev/dev-2-4/src/com/flagstone/transform/FSActionObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSAudioData.java
   dev/dev-2-4/src/com/flagstone/transform/FSBitmapFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSBounds.java
   dev/dev-2-4/src/com/flagstone/transform/FSButton.java
   dev/dev-2-4/src/com/flagstone/transform/FSButtonColorTransform.java
   dev/dev-2-4/src/com/flagstone/transform/FSButtonEvent.java
   dev/dev-2-4/src/com/flagstone/transform/FSButtonSound.java
   dev/dev-2-4/src/com/flagstone/transform/FSCall.java
   dev/dev-2-4/src/com/flagstone/transform/FSCharacter.java
   dev/dev-2-4/src/com/flagstone/transform/FSClipEvent.java
   dev/dev-2-4/src/com/flagstone/transform/FSCoder.java
   dev/dev-2-4/src/com/flagstone/transform/FSColor.java
   dev/dev-2-4/src/com/flagstone/transform/FSColorTransform.java
   dev/dev-2-4/src/com/flagstone/transform/FSCoordTransform.java
   dev/dev-2-4/src/com/flagstone/transform/FSCurve.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineButton.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineButton2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineFont.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineFont2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineImage.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineImage2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage3.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineMorphShape.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineMovieClip.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineShape.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineShape2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineShape3.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineSound.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineText.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineText2.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineTextField.java
   dev/dev-2-4/src/com/flagstone/transform/FSDefineVideo.java
   dev/dev-2-4/src/com/flagstone/transform/FSDoAction.java
   dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger.java
   dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger2.java
   dev/dev-2-4/src/com/flagstone/transform/FSEnvelope.java
   dev/dev-2-4/src/com/flagstone/transform/FSExceptionHandler.java
   dev/dev-2-4/src/com/flagstone/transform/FSExport.java
   dev/dev-2-4/src/com/flagstone/transform/FSFillStyle.java
   dev/dev-2-4/src/com/flagstone/transform/FSFontInfo.java
   dev/dev-2-4/src/com/flagstone/transform/FSFontInfo2.java
   dev/dev-2-4/src/com/flagstone/transform/FSFrameLabel.java
   dev/dev-2-4/src/com/flagstone/transform/FSFree.java
   dev/dev-2-4/src/com/flagstone/transform/FSGetUrl.java
   dev/dev-2-4/src/com/flagstone/transform/FSGetUrl2.java
   dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame.java
   dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame2.java
   dev/dev-2-4/src/com/flagstone/transform/FSGotoLabel.java
   dev/dev-2-4/src/com/flagstone/transform/FSGradient.java
   dev/dev-2-4/src/com/flagstone/transform/FSGradientFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSIf.java
   dev/dev-2-4/src/com/flagstone/transform/FSImport.java
   dev/dev-2-4/src/com/flagstone/transform/FSInitialize.java
   dev/dev-2-4/src/com/flagstone/transform/FSJPEGEncodingTable.java
   dev/dev-2-4/src/com/flagstone/transform/FSJump.java
   dev/dev-2-4/src/com/flagstone/transform/FSKerning.java
   dev/dev-2-4/src/com/flagstone/transform/FSLimitScript.java
   dev/dev-2-4/src/com/flagstone/transform/FSLine.java
   dev/dev-2-4/src/com/flagstone/transform/FSLineStyle.java
   dev/dev-2-4/src/com/flagstone/transform/FSMorphBitmapFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSMorphGradient.java
   dev/dev-2-4/src/com/flagstone/transform/FSMorphGradientFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSMorphLineStyle.java
   dev/dev-2-4/src/com/flagstone/transform/FSMorphSolidFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSMovie.java
   dev/dev-2-4/src/com/flagstone/transform/FSMovieObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSNewFunction.java
   dev/dev-2-4/src/com/flagstone/transform/FSNewFunction2.java
   dev/dev-2-4/src/com/flagstone/transform/FSPathsArePostscript.java
   dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject2.java
   dev/dev-2-4/src/com/flagstone/transform/FSPointer.java
   dev/dev-2-4/src/com/flagstone/transform/FSProtect.java
   dev/dev-2-4/src/com/flagstone/transform/FSPush.java
   dev/dev-2-4/src/com/flagstone/transform/FSQuicktimeMovie.java
   dev/dev-2-4/src/com/flagstone/transform/FSRegisterCopy.java
   dev/dev-2-4/src/com/flagstone/transform/FSRegisterVariable.java
   dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject2.java
   dev/dev-2-4/src/com/flagstone/transform/FSSerialNumber.java
   dev/dev-2-4/src/com/flagstone/transform/FSSetBackgroundColor.java
   dev/dev-2-4/src/com/flagstone/transform/FSSetTarget.java
   dev/dev-2-4/src/com/flagstone/transform/FSShape.java
   dev/dev-2-4/src/com/flagstone/transform/FSShapeObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSShapeStyle.java
   dev/dev-2-4/src/com/flagstone/transform/FSShowFrame.java
   dev/dev-2-4/src/com/flagstone/transform/FSSolidFill.java
   dev/dev-2-4/src/com/flagstone/transform/FSSound.java
   dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamBlock.java
   dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead.java
   dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead2.java
   dev/dev-2-4/src/com/flagstone/transform/FSStartSound.java
   dev/dev-2-4/src/com/flagstone/transform/FSTabOrder.java
   dev/dev-2-4/src/com/flagstone/transform/FSTable.java
   dev/dev-2-4/src/com/flagstone/transform/FSText.java
   dev/dev-2-4/src/com/flagstone/transform/FSUnknownAction.java
   dev/dev-2-4/src/com/flagstone/transform/FSUnknownObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSVideo.java
   dev/dev-2-4/src/com/flagstone/transform/FSVideoData.java
   dev/dev-2-4/src/com/flagstone/transform/FSVideoFrame.java
   dev/dev-2-4/src/com/flagstone/transform/FSVideoMetaData.java
   dev/dev-2-4/src/com/flagstone/transform/FSVideoObject.java
   dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame.java
   dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame2.java
   dev/dev-2-4/src/com/flagstone/transform/FSWith.java
   dev/dev-2-4/src/com/flagstone/transform/test/FSColorTest.java
   dev/dev-2-4/src/com/flagstone/transform/test/FSProtectTest.java
   dev/dev-2-4/src/com/flagstone/transform/test/FSSetBackgroundColorTest.java
   dev/dev-2-4/src/com/flagstone/transform/test/FSShowFrameTest.java
   dev/dev-2-4/src/com/flagstone/transform/util/FSImageConstructor.java
   dev/dev-2-4/src/com/flagstone/transform/util/FSSoundConstructor.java
   dev/dev-2-4/src/com/flagstone/transform/util/FSTextConstructor.java
Log:
Separated coder context into a separate class

Modified: dev/dev-2-4/src/com/flagstone/transform/Codeable.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/Codeable.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/Codeable.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -1,10 +1,28 @@
 package com.flagstone.transform;
 
+/**
+ * This interface is implemented by all the classes in the Transform framework
+ * that are able to encode and decode themselves as binary data.
+ * 
+ * If you add a class to the framework it must implement this interface.
+ * 
+ */
 public interface Codeable
 {
-	public int length(FSCoder coder);
+	/**
+	 * This method returns the length in bytes of an object when it is 
+	 * encoded. 
+	 * 
+	 * The length method on all objects to be encoded is called before the 
+	 * encoding process start so it is also used to initialise variables, such 
+	 * as offsets and flags that will be used when the object is encoded. This
+	 * allows the encoding process to take place in a single pass.
+	 * 
+	 * @return the length in bytes of the object when it is encoded.
+	 */
+	public int length(FSContext context);
 
-	public void encode(FSCoder coder);
+	public void encode(FSCoder coder, FSContext context);
 
-	public void decode(FSCoder coder);
+	public void decode(FSCoder coder, FSContext context);
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSAction.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSAction.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSAction.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -1533,10 +1533,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSAction(FSCoder coder)
+	public FSAction(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**

Modified: dev/dev-2-4/src/com/flagstone/transform/FSActionObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSActionObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSActionObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -453,7 +453,7 @@
 		&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, // 127
 	};
 
-	static FSActionObject decodeAction(FSCoder coder)
+	static FSActionObject decodeAction(FSCoder coder, FSContext context)
 	{
 		FSActionObject anAction = null;
 
@@ -485,21 +485,21 @@
 				coder.adjustPointer(8);
 				break;
 			case FSActionObject.GetUrl:
-				anAction = new FSGetUrl(coder);
+				anAction = new FSGetUrl(coder, context);
 				break;
 			// Flash 3
 			case FSActionObject.GotoFrame:
-				anAction = new FSGotoFrame(coder);
+				anAction = new FSGotoFrame(coder, context);
 				break;
 			// Flash 4
 			case FSActionObject.GotoLabel:
-				anAction = new FSGotoLabel(coder);
+				anAction = new FSGotoLabel(coder, context);
 				break;
 			case FSActionObject.SetTarget:
-				anAction = new FSSetTarget(coder);
+				anAction = new FSSetTarget(coder, context);
 				break;
 			case FSActionObject.WaitForFrame:
-				anAction = new FSWaitForFrame(coder);
+				anAction = new FSWaitForFrame(coder, context);
 				break;
 			case FSAction.IntegerAdd:
 			case FSAction.Subtract:
@@ -543,22 +543,22 @@
 				coder.setPointer(next);
 				break;
 			case FSActionObject.Push:
-				anAction = new FSPush(coder);
+				anAction = new FSPush(coder, context);
 				break;
 			case FSActionObject.WaitForFrame2:
-				anAction = new FSWaitForFrame2(coder);
+				anAction = new FSWaitForFrame2(coder, context);
 				break;
 			case FSActionObject.Jump:
-				anAction = new FSJump(coder);
+				anAction = new FSJump(coder, context);
 				break;
 			case FSActionObject.If:
-				anAction = new FSIf(coder);
+				anAction = new FSIf(coder, context);
 				break;
 			case FSActionObject.GetUrl2:
-				anAction = new FSGetUrl2(coder);
+				anAction = new FSGetUrl2(coder, context);
 				break;
 			case FSActionObject.GotoFrame2:
-				anAction = new FSGotoFrame2(coder);
+				anAction = new FSGotoFrame2(coder, context);
 				break;
 			// Flash 5
 			case FSAction.Add:
@@ -597,20 +597,20 @@
 				coder.adjustPointer(8);
 				break;
 			case FSActionObject.Table:
-				anAction = new FSTable(coder);
+				anAction = new FSTable(coder, context);
 				length = anAction.length;
 				next = start + (length &lt;&lt; 3);
 				break;
 			case FSActionObject.RegisterCopy:
-				anAction = new FSRegisterCopy(coder);
+				anAction = new FSRegisterCopy(coder, context);
 				break;
 			case FSActionObject.NewFunction:
-				anAction = new FSNewFunction(coder);
+				anAction = new FSNewFunction(coder, context);
 				length = anAction.length;
 				next = start + (length &lt;&lt; 3);
 				break;
 			case FSActionObject.With:
-				anAction = new FSWith(coder);
+				anAction = new FSWith(coder, context);
 				length = anAction.length;
 				next = start + (length &lt;&lt; 3);
 				break;
@@ -632,10 +632,10 @@
 				coder.adjustPointer(8);
 				break;
 			case FSActionObject.ExceptionHandler:
-				anAction = new FSExceptionHandler(coder);
+				anAction = new FSExceptionHandler(coder, context);
 				break;
 			case FSActionObject.NewFunction2:
-				anAction = new FSNewFunction2(coder);
+				anAction = new FSNewFunction2(coder, context);
 				length = anAction.length;
 				next = start + (length &lt;&lt; 3);
 				break;
@@ -648,16 +648,16 @@
 					{
 						Class&lt;FSActionObject&gt; obj = table.get(key);
 						anAction = (FSActionObject) obj.newInstance();
-						anAction.decode(coder);
+						anAction.decode(coder, context);
 						length = anAction.length;
 						next = start + (length &lt;&lt; 3);
 					} catch (Exception e)
 					{
-						anAction = new FSUnknownAction(coder);
+						anAction = new FSUnknownAction(coder, context);
 					}
 				} else
 				{
-					anAction = new FSUnknownAction(coder);
+					anAction = new FSUnknownAction(coder, context);
 				}
 				break;
 		}
@@ -666,11 +666,11 @@
 
 		if (delta != 0)
 		{
-			coder.context[FSCoder.CodingError] = 1;
-			coder.context[FSCoder.TypeInError] = anAction.getType();
-			coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-			coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-			coder.context[FSCoder.Delta] = delta;
+			context.codingError = true;
+			context.typeInError = anAction.getType();
+			context.startOfError = objStart &gt;&gt;&gt; 3;
+			context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+			context.delta = delta;
 		}
 
 		coder.setPointer(next);
@@ -681,12 +681,14 @@
 	static ArrayList&lt;FSActionObject&gt; decodeActions(byte[] encodedActions)
 	{
 		FSCoder coder = new FSCoder(FSCoder.LITTLE_ENDIAN, encodedActions);
+		FSContext context = new FSContext();
+		
 		int length = encodedActions.length;
 
-		return decodeActions(coder, length);
+		return decodeActions(coder, context, length);
 	}
 
-	static ArrayList&lt;FSActionObject&gt; decodeActions(FSCoder coder, int length)
+	static ArrayList&lt;FSActionObject&gt; decodeActions(FSCoder coder, FSContext context, int length)
 	{
 		ArrayList&lt;FSActionObject&gt; array = new ArrayList&lt;FSActionObject&gt;();
 		int start;
@@ -694,13 +696,13 @@
 		while (length &gt; 0)
 		{
 			start = coder.getPointer();
-			array.add(decodeAction(coder));
+			array.add(decodeAction(coder, context));
 			length -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 		}
 		return array;
 	}
 
-	static void encode(FSCoder coder, ArrayList&lt;FSActionObject&gt; array)
+	static void encode(FSCoder coder, FSContext context, ArrayList&lt;FSActionObject&gt; array)
 	{
 		if (array != null)
 		{
@@ -717,17 +719,17 @@
 				next = start + ((action.getType() &gt; 128) ? 24 : 8);
 				next = next + (action.getLength() &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 
 				delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = start &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - start) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = start &gt;&gt;&gt; 3;
+					context.expectedLength = (next - start) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 				coder.setPointer(next);
 			}
@@ -775,8 +777,8 @@
 	 * To add support for a new action simply sub-class FSActionObject and
 	 * implement the following methods:
 	 * 
-	 * public int length(FSCoder coder) public void encode(FSCoder coder) public
-	 * void decode(FSCoder coder)
+	 * public int length(FSContext context) public void encode(FSCoder coder, FSContext context) public
+	 * void decode(FSCoder coder, FSContext context)
 	 * 
 	 * In addition you must implement the nullary or empty constructor so that
 	 * the object can be instantiated correctly.
@@ -839,7 +841,7 @@
 	{
 		int encodedLength = (type &gt; 128) ? 3 : 1;
 
-		encodedLength += length(new FSCoder(FSCoder.LITTLE_ENDIAN, new byte[0]));
+		encodedLength += length(new FSContext());
 
 		return encodedLength;
 	}
@@ -898,14 +900,14 @@
 		return name[type];
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		length = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeByte(type);
 
@@ -913,7 +915,7 @@
 			coder.writeWord(length, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		type = coder.readByte();
 		length = type &lt; 128 ? 0 : coder.readWord(2, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSAudioData.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSAudioData.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSAudioData.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -116,10 +116,10 @@
 	private int playbackSampleSize;
 	private byte[] soundData;
 
-	public FSAudioData(FSCoder coder)
+	public FSAudioData(FSCoder coder, FSContext context)
 	{
 		super(FSVideoObject.AudioData, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -321,18 +321,18 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1 + soundData.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(format, 4);
 
@@ -356,9 +356,9 @@
 		coder.writeBytes(soundData);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		format = coder.readBits(4, false);
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSBitmapFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSBitmapFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSBitmapFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -164,10 +164,10 @@
 	 *            an FSCoder object containing an FSBitmapFill encoded as binary
 	 *            data.
 	 */
-	public FSBitmapFill(FSCoder coder)
+	public FSBitmapFill(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -299,28 +299,28 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
+		int length = super.length(context);
 
-		length += 2 + transform.length(coder);
+		length += 2 + transform.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
-		transform.encode(coder);
+		transform.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSBounds.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSBounds.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSBounds.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -141,9 +141,9 @@
 	 *            an FSCoder object containing an FSBounds encoded as binary
 	 *            data.
 	 */
-	public FSBounds(FSCoder coder)
+	public FSBounds(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -412,13 +412,13 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		size = FSCoder.size(new int[] {minX, maxX, minY, maxY }, true);
 		return ((5+size&lt;&lt;2)+7) &gt;&gt; 3;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.alignToByte();
 		coder.writeBits(size, 5);
@@ -429,7 +429,7 @@
 		coder.alignToByte();
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		coder.alignToByte();
 		size = coder.readBits(5, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSButton.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSButton.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSButton.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -164,9 +164,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSButton(FSCoder coder)
+	public FSButton(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -488,33 +488,33 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 0;
 
 		length += 5;
-		length += transform.length(coder);
+		length += transform.length(context);
 		// Flash 3
-		if (coder.context[FSCoder.Type] == FSMovieObject.DefineButton2)
-			length += colorTransform.length(coder);
+		if (context.type == FSMovieObject.DefineButton2)
+			length += colorTransform.length(context);
 		// End Flash 3
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeBits(0, 4);
 		coder.writeBits(state, 4);
 		coder.writeWord(identifier, 2);
 		coder.writeWord(layer, 2);
-		transform.encode(coder);
+		transform.encode(coder, context);
 		// Flash 3
-		if (coder.context[FSCoder.Type] == FSMovieObject.DefineButton2)
-			colorTransform.encode(coder);
+		if (context.type == FSMovieObject.DefineButton2)
+			colorTransform.encode(coder, context);
 		// End Flash 3
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		coder.readBits(4, false);
 
@@ -522,10 +522,10 @@
 		identifier = coder.readWord(2, false);
 		layer = coder.readWord(2, false);
 
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 		// Flash 3
-		if (coder.context[FSCoder.Type] == FSMovieObject.DefineButton2)
-			colorTransform = new FSColorTransform(coder);
+		if (context.type == FSMovieObject.DefineButton2)
+			colorTransform = new FSColorTransform(coder, context);
 		// End Flash 3
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSButtonColorTransform.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSButtonColorTransform.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSButtonColorTransform.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -85,10 +85,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSButtonColorTransform(FSCoder coder)
+	public FSButtonColorTransform(FSCoder coder, FSContext context)
 	{
 		super(ButtonColorTransform);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -215,29 +215,29 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
-		length += colorTransform.length(coder);
+		length += colorTransform.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
-		colorTransform.encode(coder);
+		colorTransform.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
-		colorTransform = new FSColorTransform(coder);
+		colorTransform = new FSColorTransform(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSButtonEvent.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSButtonEvent.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSButtonEvent.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -407,10 +407,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSButtonEvent(FSCoder coder, int len)
+	public FSButtonEvent(FSCoder coder, FSContext context, int len)
 	{
 		length = len - 2;
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -628,7 +628,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		length = 2;
 
@@ -640,7 +640,7 @@
 			{
 				currentAction = (FSActionObject) i.next();
 
-				length += currentAction.length(coder);
+				length += currentAction.length(context);
 				length += (currentAction.getType() &gt; 128) ? 3 : 1;
 			}
 
@@ -662,7 +662,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(event, 2);
 
@@ -680,18 +680,18 @@
 								+ ((action.getType() &gt; 128) ? 24 : 8);
 				int next = start + (length &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 				coder.setPointer(next);
 
 				int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = objStart &gt;&gt;&gt; 3;
+					context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 			}
 
@@ -711,11 +711,11 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		event = coder.readWord(2, false);
 
-		if (coder.context[FSCoder.DecodeActions] == 1)
+		if (context.decodeActions)
 		{
 			actions = new ArrayList();
 
@@ -725,7 +725,7 @@
 			{
 				start = coder.getPointer();
 
-				actions.add(FSActionObject.decodeAction(coder));
+				actions.add(FSActionObject.decodeAction(coder, context));
 				length -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 			}
 		} else

Modified: dev/dev-2-4/src/com/flagstone/transform/FSButtonSound.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSButtonSound.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSButtonSound.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -134,10 +134,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSButtonSound(FSCoder coder)
+	public FSButtonSound(FSCoder coder, FSContext context)
 	{
 		super(ButtonSound);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -303,16 +303,16 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		for (int i = 0; i &lt; 4; i++)
 		{
 			if (sound[i] != null &amp;&amp; sound[i].getIdentifier() != 0)
-				length += sound[i].length(coder);
+				length += sound[i].length(context);
 			else
 				length += 2;
 		}
@@ -320,24 +320,24 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
 
 		for (int i = 0; i &lt; 4; i++)
 		{
 			if (sound[i] != null &amp;&amp; sound[i].getIdentifier() != 0)
-				sound[i].encode(coder);
+				sound[i].encode(coder, context);
 			else
 				coder.writeWord(0, 2);
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer();
 
@@ -346,7 +346,7 @@
 		for (int i = 0; i &lt; 4; i++)
 		{
 			if (coder.scanWord(2, false) &gt; 0)
-				sound[i] = new FSSound(coder);
+				sound[i] = new FSSound(coder, context);
 			else
 				coder.readWord(2, false);
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSCall.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSCall.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSCall.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -104,10 +104,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSCall(FSCoder coder)
+	public FSCall(FSCoder coder, FSContext context)
 	{
 		super(Call);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**

Modified: dev/dev-2-4/src/com/flagstone/transform/FSCharacter.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSCharacter.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSCharacter.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -153,9 +153,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSCharacter(FSCoder coder)
+	public FSCharacter(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -296,24 +296,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int numberOfGlyphBits = coder.context[FSCoder.NumberOfGlyphBits];
-		int numberOfAdvanceBits = coder.context[FSCoder.NumberOfAdvanceBits];
+		int numberOfGlyphBits = context.glyphSize;
+		int numberOfAdvanceBits = context.advanceSize;
 
 		return numberOfGlyphBits + numberOfAdvanceBits;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		coder.writeBits(glyphIndex, coder.context[FSCoder.NumberOfGlyphBits]);
-		coder.writeBits(advance, coder.context[FSCoder.NumberOfAdvanceBits]);
+		coder.writeBits(glyphIndex, context.glyphSize);
+		coder.writeBits(advance, context.advanceSize);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		int numberOfGlyphBits = coder.context[FSCoder.NumberOfGlyphBits];
-		int numberOfAdvanceBits = coder.context[FSCoder.NumberOfAdvanceBits];
+		int numberOfGlyphBits = context.glyphSize;
+		int numberOfAdvanceBits = context.advanceSize;
 
 		glyphIndex = coder.readBits(numberOfGlyphBits, false);
 		advance = coder.readBits(numberOfAdvanceBits, true);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSClipEvent.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSClipEvent.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSClipEvent.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -388,9 +388,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSClipEvent(FSCoder coder)
+	public FSClipEvent(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -681,9 +681,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = 4 + ((coder.context[FSCoder.Version] &gt; 5) ? 4 : 2);
+		int length = 4 + ((context.version &gt; 5) ? 4 : 2);
 
 		// Flash 6
 		length += ((event &amp; KeyPress) != 0) ? 1 : 0;
@@ -697,7 +697,7 @@
 			{
 				currentAction = (FSActionObject) i.next();
 
-				length += currentAction.length(coder);
+				length += currentAction.length(context);
 				length += (currentAction.getType() &gt; 128) ? 3 : 1;
 			}
 
@@ -719,9 +719,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		int eventSize = (coder.context[FSCoder.Version] &gt; 5) ? 4 : 2;
+		int eventSize = (context.version &gt; 5) ? 4 : 2;
 
 		int offset = 0;
 
@@ -779,18 +779,18 @@
 								+ ((action.getType() &gt; 128) ? 24 : 8);
 				int next = start + (length &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 				coder.setPointer(next);
 
 				int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = objStart &gt;&gt;&gt; 3;
+					context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 			}
 
@@ -810,9 +810,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		int eventSize = (coder.context[FSCoder.Version] &gt; 5) ? 4 : 2;
+		int eventSize = (context.version &gt; 5) ? 4 : 2;
 
 		event = coder.readWord(eventSize, false);
 		int length = coder.readWord(4, false);
@@ -825,7 +825,7 @@
 		}
 		// End Flash 6
 
-		if (coder.context[FSCoder.DecodeActions] == 1)
+		if (context.decodeActions)
 		{
 			FSActionObject action;
 			int start;
@@ -836,7 +836,7 @@
 			{
 				start = coder.getPointer();
 
-				action = FSActionObject.decodeAction(coder);
+				action = FSActionObject.decodeAction(coder, context);
 				actions.add(action);
 				length -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSCoder.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSCoder.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSCoder.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -269,8 +269,6 @@
 	 */
 	public FSCoder(int order, int size)
 	{
-		clearContext();
-
 		byteOrder = order;
 		data = new byte[size];
 
@@ -292,15 +290,13 @@
 	 */
 	public FSCoder(int order, byte[] bytes)
 	{
-		clearContext();
-
 		byteOrder = order;
 		data = bytes;
 		ptr = 0;
 		end = data.length &lt;&lt; 3;
 	}
 
-	public boolean equals(FSCoder coder)
+	public boolean equals(FSCoder coder, FSContext context)
 	{
 		boolean result = true;
 
@@ -1119,80 +1115,4 @@
 		}
 		return found;
 	}
-
-	/*
-	 * Context variables are used to pass information between objects when they
-	 * are being encoded or decoded. Context variables are primarily used within
-	 * the Transform classes however they are also used when performing unit
-	 * tests on classes.
-	 */
-
-	/**
-	 * TransparentColors is used to pass information to FSCOlor objects when
-	 * they are being encoded or decoded so that the alpha channel will be
-	 * included.
-	 */
-	public static final int TransparentColors = 0;
-
-	static final int Action = 1;
-
-	/**
-	 * Version is used to pass the current version of Flash that an object is
-	 * being encoded or decoded for.
-	 */
-	public static final int Version = 2;
-
-	static final int Type = 3;
-
-	static final int Empty = 4;
-
-	static final int Identifier = 5;
-
-	static final int NumberOfFillBits = 6;
-
-	static final int NumberOfLineBits = 7;
-
-	static final int NumberOfAdvanceBits = 8;
-
-	static final int NumberOfGlyphBits = 9;
-
-	static final int NumberOfShapeBits = 10;
-
-	static final int ArrayCountExtended = 11;
-
-	static final int WideCodes = 12;
-
-	static final int Delta = 13;
-
-	static final int CodingError = 14;
-
-	static final int TypeInError = 15;
-
-	static final int StartOfError = 16;
-
-	static final int ExpectedLength = 17;
-
-	static final int DecodeActions = 18;
-
-	static final int DecodeShapes = 19;
-
-	static final int DecodeGlyphs = 20;
-
-	int[] context = new int[21];
-
-	private void clearContext()
-	{
-		for (int i = 0; i &lt; context.length; i++)
-			context[i] = 0;
-	}
-
-	public int getContext(int key)
-	{
-		return context[key];
-	}
-
-	public void setContext(int key, int value)
-	{
-		context[key] = value;
-	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSColor.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSColor.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSColor.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -145,10 +145,10 @@
 	 *            an FSCoder object containing an FSColor encoded as binary
 	 *            data.
 	 */
-	public FSColor(FSCoder coder)
+	public FSColor(FSCoder coder, FSContext context)
 	{
 		alpha = 255;
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -414,28 +414,28 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		return (coder.context[FSCoder.TransparentColors] != 0) ? 4 : 3;
+		return (context.transparent) ? 4 : 3;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeByte(red);
 		coder.writeByte(green);
 		coder.writeByte(blue);
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			coder.writeByte(alpha);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		red = coder.readByte();
 		green = coder.readByte();
 		blue = coder.readByte();
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			alpha = coder.readByte();
 	}
 }
\ No newline at end of file

Modified: dev/dev-2-4/src/com/flagstone/transform/FSColorTransform.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSColorTransform.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSColorTransform.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -234,9 +234,9 @@
 	 * @param coder
 	 *            an FSCoder object containing the encoded colour transform.
 	 */
-	public FSColorTransform(FSCoder coder)
+	public FSColorTransform(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -847,15 +847,14 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfBits = 13; // include extra 7 bits for byte alignment
-		int numberOfTerms = coder.context[FSCoder.TransparentColors] != 0 ? 4: 3;
+		int numberOfTerms = context.transparent ? 4: 3;
 
-		size = fieldSize(coder);
-		hasMul = containsMultiplyTerms(coder);
-		hasAdd = containsAddTerms(coder);
-		
+		size = fieldSize(context);
+		hasMul = containsMultiplyTerms(context);
+		hasAdd = containsAddTerms(context);
 
 		if (hasMul) {
 			numberOfBits += size*numberOfTerms;
@@ -868,7 +867,7 @@
 		return numberOfBits &gt;&gt; 3;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.alignToByte();
 
@@ -882,7 +881,7 @@
 			coder.writeFixedBits(mulGreen, size, 8);
 			coder.writeFixedBits(mulBlue, size, 8);
 
-			if (coder.context[FSCoder.TransparentColors] != 0)
+			if (context.transparent)
 				coder.writeFixedBits(mulAlpha, size, 8);
 		}
 		
@@ -892,14 +891,14 @@
 			coder.writeBits(addGreen, size);
 			coder.writeBits(addBlue, size);
 
-			if (coder.context[FSCoder.TransparentColors] != 0)
+			if (context.transparent)
 				coder.writeBits(addAlpha, size);
 		}
 		
 		coder.alignToByte();
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		coder.alignToByte();
 
@@ -913,7 +912,7 @@
 			mulGreen = coder.readFixedBits(size, 8);
 			mulBlue = coder.readFixedBits(size, 8);
 
-			if (coder.context[FSCoder.TransparentColors] != 0)
+			if (context.transparent)
 				mulAlpha = coder.readFixedBits(size, 8);
 		}
 		else 
@@ -930,7 +929,7 @@
 			addGreen = coder.readBits(size, true);
 			addBlue = coder.readBits(size, true);
 
-			if (coder.context[FSCoder.TransparentColors] != 0)
+			if (context.transparent)
 				addAlpha = coder.readBits(size, true);
 		}
 		else 
@@ -944,17 +943,17 @@
 		coder.alignToByte();
 	}
 
-	private boolean containsAddTerms(FSCoder coder)
+	private boolean containsAddTerms(FSContext context)
 	{
 		int sum = addRed + addGreen + addBlue;
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			sum += addAlpha;
 
 		return sum != 0;
 	}
 
-	private boolean containsMultiplyTerms(FSCoder coder)
+	private boolean containsMultiplyTerms(FSContext context)
 	{
 		float sum = mulRed + mulGreen + mulBlue;
 		
@@ -962,17 +961,17 @@
 			sum = 0.0f;
 		}
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			sum += mulAlpha;
 
 		return sum != 1.0f;
 	}
 
-	private int addFieldSize(FSCoder coder)
+	private int addFieldSize(FSContext context)
 	{
 		int[] values;
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			values = new int[] { addRed, addGreen, addBlue, addAlpha };
 		else
 			values = new int[] { addRed, addGreen, addBlue };
@@ -980,11 +979,11 @@
 		return FSCoder.size(values, true);
 	}
 
-	private int multiplyFieldSize(FSCoder coder)
+	private int multiplyFieldSize(FSContext context)
 	{
 		float[] values;
 
-		if (coder.context[FSCoder.TransparentColors] != 0)
+		if (context.transparent)
 			values = new float[] { mulRed, mulGreen, mulBlue, mulAlpha };
 		else
 			values = new float[] { mulRed, mulGreen, mulBlue };
@@ -992,19 +991,19 @@
 		return FSCoder.fixedShortSize(values);
 	}
 
-	private int fieldSize(FSCoder coder)
+	private int fieldSize(FSContext context)
 	{
-		boolean containsMultiplyTerms = containsMultiplyTerms(coder);
-		boolean containsAddTerms = containsAddTerms(coder);
+		boolean containsMultiplyTerms = containsMultiplyTerms(context);
+		boolean containsAddTerms = containsAddTerms(context);
 		int numberOfBits = 0;
 
 		if (containsAddTerms &amp;&amp; !containsMultiplyTerms)
-			numberOfBits = addFieldSize(coder);
+			numberOfBits = addFieldSize(context);
 		else if (!containsAddTerms &amp;&amp; containsMultiplyTerms)
-			numberOfBits = multiplyFieldSize(coder);
+			numberOfBits = multiplyFieldSize(context);
 		else if (containsAddTerms &amp;&amp; containsMultiplyTerms)
-			numberOfBits = Math.max(addFieldSize(coder),
-							multiplyFieldSize(coder));
+			numberOfBits = Math.max(addFieldSize(context),
+							multiplyFieldSize(context));
 		else
 			numberOfBits = 1;
 

Added: dev/dev-2-4/src/com/flagstone/transform/FSContext.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSContext.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSContext.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -0,0 +1,69 @@
+package com.flagstone.transform;
+
+/**
+ * FSContext are used to pass information between objects when they are being 
+ * encoded or decoded. Context variables are primarily used within the Transform 
+ * classes however they are also used when performing unit tests on classes.
+ */
+public class FSContext
+{
+	/** The version of Flash that an object is being encoded or decoded for. */
+	public int version;
+	/** The type of the object being decoded. */
+	public int type;
+	/** The unique identifier assigned to an object */
+	public int identifier;
+
+	/** Indicates that an object does not contain data */ 
+	public boolean empty;
+	/** Indicates that FSColor objects should also encode their alpha channel. */
+	public boolean transparent;
+	/** Indicates the character codes in a font are 16-bit values rather than 8-bit. */
+	public boolean wideCodes;
+	/** Indicates arrays of actions should be decoded instead of leaving them as binary data. */
+	public boolean decodeActions;
+	/** Indicates arrays of shapes should be decoded instead of leaving them as binary data. */
+	public boolean decodeShapes;
+	/** Indicates arrays of glyphs should be decoded instead of leaving them as binary data. */
+	public boolean decodeGlyphs;
+	/** Indicates that an array can contain more than 255 entries. */
+	public boolean arrayExtended;
+
+	/** Contains the number of bits used to encode the index into the fill style array. */
+	public int fillSize;
+	/** Contains the number of bits used to encode the index into the line style array. */
+	public int lineSize;
+	/** Contains the number of bits used to encode the advance between two successive glyphs. */
+	public int advanceSize;
+	/** Contains the number of bits used to encode shape segments in a glyph. */
+	public int glyphSize;
+	/** Contains the number of bits used to encode shape segments in a shape. */
+	public int shapeSize;
+
+	/*
+	 * The following variables are used to pass information back to the parent
+	 * movie object when an object is encoded or decoded.
+	 */
+	
+	/** Indicates an error occurred when encoding or decoding an object. */
+	public boolean codingError;
+	/**
+	 * Contains the type of the object that caused the error.
+	 */
+	public int typeInError;
+	/**
+	 * Contains the expected length of the binary data for an object when it is 
+	 * encoded or decoded.
+	 */
+	public int expectedLength;
+	/** 
+	 * Contains the difference between the expected length of an object and the 
+	 * actual number of bytes encoded or decoded.
+	 */
+	public int delta;
+	/**
+	 * Contains the position in the encoded data where the object that caused 
+	 * the error is located.
+	 */
+	public int startOfError;
+}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSCoordTransform.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSCoordTransform.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSCoordTransform.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -217,9 +217,9 @@
 	 *            an FSCoder object containing an FSColor encoded as binary
 	 *            data.
 	 */
-	public FSCoordTransform(FSCoder coder)
+	public FSCoordTransform(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -504,7 +504,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfBits = 14; // include 7 bits for byte alignment
 		
@@ -519,7 +519,7 @@
 		return numberOfBits &gt;&gt; 3;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int translateBits = translateFieldSize();
 
@@ -553,7 +553,7 @@
 		coder.alignToByte();
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int scaleFieldSize = 0;
 		int rotateFieldSize = 0;

Modified: dev/dev-2-4/src/com/flagstone/transform/FSCurve.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSCurve.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSCurve.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -116,9 +116,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSCurve(FSCoder coder)
+	public FSCurve(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -367,7 +367,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfBits = 6;
 
@@ -377,12 +377,12 @@
 
 		numberOfBits += _fieldSize * 4;
 
-		coder.context[FSCoder.NumberOfShapeBits] += numberOfBits;
+		context.shapeSize += numberOfBits;
 
 		return numberOfBits;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int _fieldSize = FSCoder.size(new int[] {controlX, controlY, anchorX, anchorY, 1 }, true);
 
@@ -396,7 +396,7 @@
 		coder.writeBits(anchorY, _fieldSize);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		// skip over shapeType and edgeType
 		coder.adjustPointer(2);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineButton.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineButton.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineButton.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -196,10 +196,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineButton(FSCoder coder)
+	public FSDefineButton(FSCoder coder, FSContext context)
 	{
 		super(DefineButton, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -434,12 +434,12 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		for (Iterator&lt;Codeable&gt; buttonIterator = buttonRecords.iterator(); buttonIterator.hasNext();)
-			length += buttonIterator.next().length(coder);
+			length += buttonIterator.next().length(context);
 
 		length += 1;
 
@@ -451,7 +451,7 @@
 			{
 				currentAction = (FSActionObject) i.next();
 
-				length += currentAction.length(coder);
+				length += currentAction.length(context);
 				length += (currentAction.getType() &gt; 128) ? 3 : 1;
 			}
 
@@ -474,12 +474,12 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		for (Iterator&lt;Codeable&gt; buttonIterator = buttonRecords.iterator(); buttonIterator.hasNext();)
-			buttonIterator.next().encode(coder);
+			buttonIterator.next().encode(coder, context);
 
 		coder.writeWord(0, 1);
 
@@ -496,18 +496,18 @@
 								+ ((action.getType() &gt; 128) ? 24 : 8);
 				int next = start + (action.getLength() &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 				coder.setPointer(next);
 
 				int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = objStart &gt;&gt;&gt; 3;
+					context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 			}
 
@@ -527,22 +527,22 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer() - 16;
 
 		buttonRecords = new ArrayList();
 
 		while (coder.scanWord(1, false) != 0)
-			buttonRecords.add(new FSButton(coder));
+			buttonRecords.add(new FSButton(coder, context));
 
 		coder.readByte(); // character end
 
 		int actionsLength = length - ((coder.getPointer() - start) &gt;&gt;&gt; 3);
 
-		if (coder.context[FSCoder.DecodeActions] == 1)
+		if (context.decodeActions)
 		{
 			actions = new ArrayList();
 
@@ -550,7 +550,7 @@
 			{
 				start = coder.getPointer();
 
-				actions.add(FSActionObject.decodeAction(coder));
+				actions.add(FSActionObject.decodeAction(coder, context));
 				actionsLength -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 			}
 		} else

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineButton2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineButton2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineButton2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -182,10 +182,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineButton2(FSCoder coder)
+	public FSDefineButton2(FSCoder coder, FSContext context)
 	{
 		super(DefineButton2, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -438,16 +438,16 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		length += 3;
 
 		for (Iterator&lt;Codeable&gt; buttonIterator = buttonRecords.iterator(); buttonIterator.hasNext();)
-			length += buttonIterator.next().length(coder);
+			length += buttonIterator.next().length(context);
 
 		length += 1;
 
@@ -456,26 +456,26 @@
 			for (Iterator&lt;Codeable&gt; eventIterator = buttonEvents.iterator(); eventIterator.hasNext();)
 			{
 				length += 2;
-				length += eventIterator.next().length(coder);
+				length += eventIterator.next().length(context);
 			}
 		} else
 		{
 			length += encodedEvents.length;
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int offsetStart = 0;
 		int offsetEnd = 0;
 		int currentCursor = 0;
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		coder.writeWord(buttonType, 1);
 
@@ -483,7 +483,7 @@
 		coder.writeWord(0, 2);
 
 		for (Iterator&lt;Codeable&gt; buttonIterator = buttonRecords.iterator(); buttonIterator.hasNext();)
-			buttonIterator.next().encode(coder);
+			buttonIterator.next().encode(coder, context);
 
 		coder.writeWord(0, 1);
 
@@ -502,8 +502,8 @@
 				FSButtonEvent anEvent = eventIterator.next();
 
 				offsetStart = coder.getPointer();
-				coder.writeWord(anEvent.length(coder) + 2, 2);
-				anEvent.encode(coder);
+				coder.writeWord(anEvent.length(context) + 2, 2);
+				anEvent.encode(coder, context);
 			}
 			// Write offset of zero for last Action Condition
 
@@ -515,20 +515,20 @@
 		{
 			coder.writeBytes(encodedEvents);
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int offsetToNext = 0;
 
 		buttonEvents = new ArrayList();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer() - 16;
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		buttonType = coder.readByte();
 		offsetToNext = coder.readWord(2, false);
@@ -536,7 +536,7 @@
 		buttonRecords = new ArrayList();
 
 		while (coder.scanWord(1, false) != 0)
-			buttonRecords.add(new FSButton(coder));
+			buttonRecords.add(new FSButton(coder, context));
 
 		coder.readByte();
 
@@ -550,17 +550,14 @@
 
 				if (offsetToNext != 0)
 				{
-					buttonEvents
-									.add(new FSButtonEvent(coder,
-													offsetToNext - 2));
+					buttonEvents.add(new FSButtonEvent(coder, context, offsetToNext - 2));
 				} else
 				{
-					buttonEvents.add(new FSButtonEvent(coder, length
-									- ((coder.getPointer() - start) &gt;&gt;&gt; 3)));
+					buttonEvents.add(new FSButtonEvent(coder, context, length - ((coder.getPointer() - start) &gt;&gt;&gt; 3)));
 				}
 			} while (offsetToNext != 0);
 
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineFont.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineFont.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineFont.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -92,10 +92,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineFont(FSCoder coder)
+	public FSDefineFont(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DefineFont, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -204,30 +204,30 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 1;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 1;
+		context.lineSize = 0;
 
 		length += shapes.size() * 2;
 
 		for (Iterator&lt;FSShape&gt; shapeIterator = shapes.iterator(); shapeIterator.hasNext();)
-			length += shapeIterator.next().length(coder);
+			length += shapeIterator.next().length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 1;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 1;
+		context.lineSize = 0;
 
 		int currentLocation;
 		int offset;
@@ -247,18 +247,18 @@
 			coder.writeWord(offset, 2);
 			coder.setPointer(currentLocation);
 
-			i.next().encode(coder);
+			i.next().encode(coder, context);
 		}
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		shapes = new ArrayList();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int offsetStart = coder.getPointer();
 		int shapeCount = coder.scanWord(2, false) / 2;
@@ -276,10 +276,10 @@
 		{
 			coder.setPointer(offsetStart + (offset[i] &lt;&lt; 3));
 
-			if (coder.context[FSCoder.DecodeGlyphs] == 1)
-				shapes.add(new FSShape(coder));
+			if (context.decodeGlyphs)
+				shapes.add(new FSShape(coder, context));
 			else
-				shapes.add(new FSShape(coder, offset[i + 1] - offset[i]));
+				shapes.add(new FSShape(coder, context, offset[i + 1] - offset[i]));
 		}
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineFont2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineFont2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineFont2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -200,10 +200,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineFont2(FSCoder coder)
+	public FSDefineFont2(FSCoder coder, FSContext context)
 	{
 		super(DefineFont2, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -799,21 +799,21 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		boolean wideOffsets = wideOffsetsForIndexedArray(shapes, coder);
-		int wideCodes = 0;
+		boolean wideOffsets = wideOffsetsForIndexedArray(shapes, context);
+		boolean wideCodes = false;
 
-		if (coder.context[FSCoder.Version] &gt; 5)
-			wideCodes = 1;
+		if (context.version &gt; 5)
+			wideCodes = true;
 		else
-			wideCodes = (encoding != FSText.ANSI) ? 1 : 0;
+			wideCodes = (encoding != FSText.ANSI) ? true : false;
 
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 1;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
-		coder.context[FSCoder.WideCodes] = wideCodes;
+		context.fillSize = 1;
+		context.lineSize = 0;
+		context.wideCodes = wideCodes;
 		length += 3;
 		length += FSCoder.strlen(name, false);
 		length += 2;
@@ -821,9 +821,9 @@
 		length += wideOffsets ? 4 : 2;
 
 		for (Iterator&lt;FSShape&gt; shapeIterator = shapes.iterator(); shapeIterator.hasNext();)
-			length += shapeIterator.next().length(coder);
+			length += shapeIterator.next().length(context);
 
-		length += shapes.size() * ((wideCodes == 1) ? 2 : 1);
+		length += shapes.size() * (wideCodes ? 2 : 1);
 
 		if (containsLayoutInfo())
 		{
@@ -831,29 +831,29 @@
 			length += shapes.size() * 2;
 
 			for (Iterator&lt;FSBounds&gt; boundsIterator = bounds.iterator(); boundsIterator.hasNext();)
-				length += boundsIterator.next().length(coder);
+				length += boundsIterator.next().length(context);
 
 			length += 2;
-			length += kernings.size() * ((wideCodes == 1) ? 6 : 4);
+			length += kernings.size() * (wideCodes ? 6 : 4);
 		}
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
-		coder.context[FSCoder.WideCodes] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
+		context.wideCodes = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		boolean wideOffsets = wideOffsetsForIndexedArray(shapes, coder);
-		int wideCodes = 0;
+		boolean wideOffsets = wideOffsetsForIndexedArray(shapes, context);
+		boolean wideCodes = false;
 		int format = 0;
 
-		if (coder.context[FSCoder.Version] &gt; 5)
-			wideCodes = 1;
+		if (context.version &gt; 5)
+			wideCodes = true;
 		else
-			wideCodes = (encoding != FSText.ANSI) ? 1 : 0;
+			wideCodes = encoding != FSText.ANSI;
 
 		if (encoding == FSText.ANSI)
 			format = 1;
@@ -864,20 +864,20 @@
 		else if (encoding == FSText.SJIS)
 			format = 4;
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 1;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
-		coder.context[FSCoder.WideCodes] = wideCodes;
+		context.fillSize = 1;
+		context.lineSize = 0;
+		context.wideCodes = wideCodes;
 
 		coder.writeBits(containsLayoutInfo() ? 1 : 0, 1);
 		coder.writeBits(format, 3);
 		coder.writeBits(wideOffsets ? 1 : 0, 1);
-		coder.writeBits(wideCodes, 1);
+		coder.writeBits(wideCodes ? 1:0, 1);
 		coder.writeBits(italic ? 1 : 0, 1);
 		coder.writeBits(bold ? 1 : 0, 1);
-		coder.writeWord(coder.context[FSCoder.Version] &gt; 5 ? language : 0, 1);
-		coder.writeWord(coder.strlen(name, false), 1);
+		coder.writeWord(context.version &gt; 5 ? language : 0, 1);
+		coder.writeWord(FSCoder.strlen(name, false), 1);
 
 		coder.writeString(name);
 		coder.writeWord(shapes.size(), 2);
@@ -901,7 +901,7 @@
 			coder.writeWord(offset, entrySize);
 			coder.setPointer(currentLocation);
 
-			i.next().encode(coder);
+			i.next().encode(coder, context);
 		}
 
 		currentLocation = coder.getPointer();
@@ -912,8 +912,7 @@
 		coder.setPointer(currentLocation);
 
 		for (Iterator codesIterator = codes.iterator(); codesIterator.hasNext();)
-			coder.writeWord(((Integer) codesIterator.next()).intValue(),
-							(wideCodes == 1) ? 2 : 1);
+			coder.writeWord(((Integer) codesIterator.next()).intValue(), wideCodes ? 2 : 1);
 
 		if (containsLayoutInfo())
 		{
@@ -928,21 +927,21 @@
 
 			for (Iterator&lt;FSBounds&gt; boundsIterator = bounds.iterator(); boundsIterator
 							.hasNext();)
-				boundsIterator.next().encode(coder);
+				boundsIterator.next().encode(coder, context);
 
 			coder.writeWord(kernings.size(), 2);
 
 			for (Iterator&lt;FSKerning&gt; kerningIterator = kernings.iterator(); kerningIterator
 							.hasNext();)
-				kerningIterator.next().encode(coder);
+				kerningIterator.next().encode(coder, context);
 		}
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
-		coder.context[FSCoder.WideCodes] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
+		context.wideCodes = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		boolean containsWideOffsets = false;
 		boolean containsWideCodes = false;
@@ -952,7 +951,7 @@
 		int kerningCount = 0;
 		int nameLength = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		containsLayout = coder.readBits(1, false) != 0 ? true : false;
 		int format = coder.readBits(3, false);
@@ -971,7 +970,7 @@
 		containsWideOffsets = coder.readBits(1, false) != 0 ? true : false;
 		containsWideCodes = coder.readBits(1, false) != 0 ? true : false;
 
-		coder.context[FSCoder.WideCodes] = containsWideCodes ? 1 : 0;
+		context.wideCodes = containsWideCodes;
 
 		italic = coder.readBits(1, false) != 0 ? true : false;
 		bold = coder.readBits(1, false) != 0 ? true : false;
@@ -1002,10 +1001,10 @@
 		{
 			coder.setPointer(offsetStart + (offset[i] &lt;&lt; 3));
 
-			if (coder.context[FSCoder.DecodeGlyphs] == 1)
-				shapes.add(new FSShape(coder));
+			if (context.decodeGlyphs)
+				shapes.add(new FSShape(coder, context));
 			else
-				shapes.add(new FSShape(coder, offset[i + 1] - offset[i]));
+				shapes.add(new FSShape(coder, context, offset[i + 1] - offset[i]));
 
 		}
 
@@ -1027,15 +1026,15 @@
 				advances.add(new Integer(coder.readWord(2, true)));
 
 			for (int i = 0; i &lt; glyphCount; i++)
-				bounds.add(new FSBounds(coder));
+				bounds.add(new FSBounds(coder, context));
 
 			kerningCount = coder.readWord(2, false);
 
 			for (int i = 0; i &lt; kerningCount; i++)
-				kernings.add(new FSKerning(coder));
+				kernings.add(new FSKerning(coder, context));
 		}
 
-		coder.context[FSCoder.WideCodes] = 0;
+		context.wideCodes = false;
 	}
 
 	private boolean containsLayoutInfo()
@@ -1052,14 +1051,14 @@
 		return layout;
 	}
 
-	private boolean wideOffsetsForIndexedArray(ArrayList&lt;FSShape&gt; anArray, FSCoder coder)
+	private boolean wideOffsetsForIndexedArray(ArrayList&lt;FSShape&gt; anArray, FSContext context)
 	{
 		boolean wideOffsets = false;
 
 		int glyphLength = 0;
 
 		for (Iterator&lt;FSShape&gt; i = anArray.iterator(); i.hasNext();)
-			glyphLength += i.next().length(coder);
+			glyphLength += i.next().length(context);
 
 		if ((anArray.size() * 2 + glyphLength) &gt; 65535)
 			wideOffsets = true;

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineImage.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineImage.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineImage.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -159,11 +159,11 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineImage(FSCoder coder)
+	public FSDefineImage(FSCoder coder, FSContext context)
 	{
 		super(DefineImage, 0);
 		extendLength = true;
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -420,9 +420,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 5;
 		length += (pixelSize == 8) ? 1 : 0;
@@ -431,9 +431,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		switch (pixelSize)
 		{
@@ -457,9 +457,9 @@
 		coder.writeBytes(compressedData);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		switch (coder.readByte())
 		{

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineImage2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineImage2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineImage2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -141,11 +141,11 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineImage2(FSCoder coder)
+	public FSDefineImage2(FSCoder coder, FSContext context)
 	{
 		super(DefineImage2, 0);
 		extendLength = true;
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -400,9 +400,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 5;
 		length += (pixelSize == 8) ? 1 : 0;
@@ -411,9 +411,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		switch (pixelSize)
 		{
@@ -434,9 +434,9 @@
 		coder.writeBytes(compressedData);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		switch (coder.readByte())
 		{

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -132,10 +132,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineJPEGImage(FSCoder coder)
+	public FSDefineJPEGImage(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DefineJPEGImage, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -245,24 +245,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += image.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeBytes(image);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		byte[] data = new byte[length - 2];
 		coder.readBytes(data);
 		setImage(data);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -135,10 +135,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineJPEGImage2(FSCoder coder)
+	public FSDefineJPEGImage2(FSCoder coder, FSContext context)
 	{
 		super(DefineJPEGImage2, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -300,9 +300,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += encodingTable.length;
 		length += image.length;
@@ -310,23 +310,23 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeBytes(encodingTable);
 		coder.writeBytes(image);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
-		setEncodingTable(readJPEGStream(coder));
+		super.decode(coder, context);
+		setEncodingTable(readJPEGStream(coder, context));
 		byte[] data = new byte[length - encodingTable.length - 2];
 		coder.readBytes(data);
 		setImage(data);
 	}
 
-	private byte[] readJPEGStream(FSCoder coder)
+	private byte[] readJPEGStream(FSCoder coder, FSContext context)
 	{
 		byte bytes[] = null;
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage3.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage3.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineJPEGImage3.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -165,10 +165,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineJPEGImage3(FSCoder coder)
+	public FSDefineJPEGImage3(FSCoder coder, FSContext context)
 	{
 		super(DefineJPEGImage3, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -339,9 +339,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
 		length += encodingTable.length;
@@ -351,9 +351,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(encodingTable.length + image.length, 4);
 		coder.writeBytes(encodingTable);
@@ -363,13 +363,13 @@
 			coder.writeBytes(alpha);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int offset = coder.readWord(4, false);
 
-		setEncodingTable(readJPEGStream(coder));
+		setEncodingTable(readJPEGStream(coder, context));
 		byte[] imageIn = new byte[offset - encodingTable.length];
 		coder.readBytes(imageIn);
 		setImage(imageIn);
@@ -378,7 +378,7 @@
 		setCompressedAlpha(alphaIn);
 	}
 
-	private byte[] readJPEGStream(FSCoder coder)
+	private byte[] readJPEGStream(FSCoder coder, FSContext context)
 	{
 		byte bytes[] = null;
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineMorphShape.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineMorphShape.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineMorphShape.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -223,10 +223,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineMorphShape(FSCoder coder)
+	public FSDefineMorphShape(FSCoder coder, FSContext context)
 	{
 		super(DefineMorphShape, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -526,60 +526,60 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		length += startBounds.length(coder);
-		length += endBounds.length(coder);
+		length += startBounds.length(context);
+		length += endBounds.length(context);
 		length += 4;
 
 		length += (fillStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
 		length += (lineStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		length += startShape.length(coder);
+		length += startShape.length(context);
 
 		// Number of Fill and Line bits is zero for end shape.
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
-		length += endShape.length(coder);
+		length += endShape.length(context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.arrayExtended = false;
+		context.transparent = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		startBounds.encode(coder);
-		endBounds.encode(coder);
+		startBounds.encode(coder, context);
+		endBounds.encode(coder, context);
 
 		int offsetStart = coder.getPointer();
 		coder.writeWord(0, 4);
@@ -595,7 +595,7 @@
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
 		if (lineStyles.size() &gt;= 255)
 		{
@@ -608,13 +608,13 @@
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			 styleIterator.next().encode(coder);
+			 styleIterator.next().encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		startShape.encode(coder);
+		startShape.encode(coder, context);
 
 		int offsetEnd = (coder.getPointer() - offsetStart) &gt;&gt; 3;
 		int currentCursor = coder.getPointer();
@@ -625,36 +625,36 @@
 
 		// Number of Fill and Line bits is zero for end shape.
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
-		endShape.encode(coder);
+		endShape.encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.arrayExtended = false;
+		context.transparent = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int fillStyleCount = 0;
 		int lineStyleCount = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
-		coder.context[FSCoder.ArrayCountExtended] = 1;
+		context.transparent = true;
+		context.arrayExtended = true;
 
 		int start = coder.getPointer() - 16;
 
-		startBounds = new FSBounds(coder);
-		endBounds = new FSBounds(coder);
+		startBounds = new FSBounds(coder, context);
+		endBounds = new FSBounds(coder, context);
 
 		int offset = coder.readWord(4, false);
 		int first = coder.getPointer();
 
 		fillStyleCount = coder.readByte();
 
-		if (coder.context[FSCoder.ArrayCountExtended] != 0
+		if (context.arrayExtended
 						&amp;&amp; fillStyleCount == 0xFF)
 			fillStyleCount = coder.readWord(2, false);
 
@@ -665,25 +665,25 @@
 			switch (coder.scanWord(1, false))
 			{
 				case FSFillStyle.Solid:
-					fillStyles.add(new FSMorphSolidFill(coder));
+					fillStyles.add(new FSMorphSolidFill(coder, context));
 					break;
 				case FSFillStyle.Linear:
-					fillStyles.add(new FSMorphGradientFill(coder));
+					fillStyles.add(new FSMorphGradientFill(coder, context));
 					break;
 				case FSFillStyle.Radial:
-					fillStyles.add(new FSMorphGradientFill(coder));
+					fillStyles.add(new FSMorphGradientFill(coder, context));
 					break;
 				case FSFillStyle.Tiled:
-					fillStyles.add(new FSMorphBitmapFill(coder));
+					fillStyles.add(new FSMorphBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Clipped:
-					fillStyles.add(new FSMorphBitmapFill(coder));
+					fillStyles.add(new FSMorphBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				default:
 					break;
@@ -692,24 +692,24 @@
 
 		lineStyleCount = coder.readByte();
 
-		if (coder.context[FSCoder.ArrayCountExtended] != 0
+		if (context.arrayExtended
 						&amp;&amp; lineStyleCount == 0xFF)
 			lineStyleCount = coder.readWord(2, false);
 
 		lineStyles = new ArrayList(lineStyleCount);
 
 		for (int i = 0; i &lt; lineStyleCount; i++)
-			lineStyles.add(new FSMorphLineStyle(coder));
+			lineStyles.add(new FSMorphLineStyle(coder, context));
 
 		int bytesDecoded = (coder.getPointer() - first) &gt;&gt; 3;
 
-		startShape = new FSShape(coder, offset - bytesDecoded);
+		startShape = new FSShape(coder, context, offset - bytesDecoded);
 
 		bytesDecoded = (coder.getPointer() - start) &gt;&gt; 3;
 
-		endShape = new FSShape(coder, length - bytesDecoded);
+		endShape = new FSShape(coder, context, length - bytesDecoded);
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.ArrayCountExtended] = 0;
+		context.transparent = false;
+		context.arrayExtended = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineMovieClip.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineMovieClip.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineMovieClip.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -98,10 +98,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineMovieClip(FSCoder coder)
+	public FSDefineMovieClip(FSCoder coder, FSContext context)
 	{
 		super(DefineMovieClip, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -230,28 +230,28 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 		
 		length += 4;
-		length += FSMovieObject.length(coder, objects);
+		length += FSMovieObject.length(context, objects);
 		
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(numberOfFrames(), 2);
-		FSMovieObject.encode(coder, objects);
+		FSMovieObject.encode(coder, context, objects);
 		coder.writeWord(0, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		/* frameCount */coder.readWord(2, false);
 
@@ -259,7 +259,7 @@
 
 		FSMovieObject object = null;
 
-		while ((object = FSMovieObject.decodeObject(coder)) != null)
+		while ((object = FSMovieObject.decodeObject(coder, context)) != null)
 		{
 			objects.add(object);
 		}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -82,25 +82,25 @@
 		identifier = anIdentifier;
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineShape.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineShape.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineShape.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -152,10 +152,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineShape(FSCoder coder)
+	public FSDefineShape(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DefineShape, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -380,77 +380,77 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.length(coder);
+		super.length(context);
 
-		length += bounds.length(coder);
+		length += bounds.length(context);
 		length += 1;
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
 		length += 1;
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		length += shape.length(coder);
+		length += shape.length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		bounds.encode(coder);
+		bounds.encode(coder, context);
 
 		coder.writeWord(fillStyles.size(), 1);
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-		 styleIterator.next().encode(coder);
+		 styleIterator.next().encode(coder, context);
 
 		coder.writeWord(lineStyles.size(), 1);
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		shape.encode(coder);
+		shape.encode(coder, context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int fillStyleCount = 0;
 		int lineStyleCount = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer() - 16; // account for identifier
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 		fillStyleCount = coder.readByte();
 
 		fillStyles = new ArrayList(fillStyleCount);
@@ -462,25 +462,25 @@
 			switch (coder.scanWord(1, false))
 			{
 				case FSFillStyle.Solid:
-					fillStyles.add(new FSSolidFill(coder));
+					fillStyles.add(new FSSolidFill(coder, context));
 					break;
 				case FSFillStyle.Linear:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Radial:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				default:
 					break;
@@ -492,13 +492,13 @@
 		lineStyles = new ArrayList(lineStyleCount);
 
 		for (int i = 0; i &lt; lineStyleCount; i++)
-			lineStyles.add(new FSLineStyle(coder));
+			lineStyles.add(new FSLineStyle(coder, context));
 
 		int bytesDecoded = (coder.getPointer() - start) &gt;&gt; 3;
 
-		if (coder.context[FSCoder.DecodeShapes] == 1)
-			shape = new FSShape(coder);
+		if (context.decodeShapes)
+			shape = new FSShape(coder, context);
 		else
-			shape = new FSShape(coder, length - bytesDecoded);
+			shape = new FSShape(coder, context, length - bytesDecoded);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineShape2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineShape2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineShape2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -154,10 +154,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineShape2(FSCoder coder)
+	public FSDefineShape2(FSCoder coder, FSContext context)
 	{
 		super(DefineShape2, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -383,47 +383,47 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.length(coder);
+		super.length(context);
 
-		length += bounds.length(coder);
+		length += bounds.length(context);
 		length += (fillStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
 		length += (lineStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		length += shape.length(coder);
+		length += shape.length(context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.arrayExtended = false;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		bounds.encode(coder);
+		bounds.encode(coder, context);
 
 		if (fillStyles.size() &gt;= 255)
 		{
@@ -436,7 +436,7 @@
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
 		if (lineStyles.size() &gt;= 255)
 		{
@@ -449,29 +449,29 @@
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		shape.encode(coder);
+		shape.encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.arrayExtended = false;
+		context.fillSize = 0;
+		context.lineSize = 0;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int fillStyleCount = 0;
 		int lineStyleCount = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer() - 16; // account for identifier
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 		fillStyleCount = coder.readByte();
 
 		if (fillStyleCount == 0xFF)
@@ -486,25 +486,25 @@
 			switch (coder.scanWord(1, false))
 			{
 				case FSFillStyle.Solid:
-					fillStyles.add(new FSSolidFill(coder));
+					fillStyles.add(new FSSolidFill(coder, context));
 					break;
 				case FSFillStyle.Linear:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Radial:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				default:
 					break;
@@ -519,17 +519,17 @@
 		lineStyles = new ArrayList(lineStyleCount);
 
 		for (int i = 0; i &lt; lineStyleCount; i++)
-			lineStyles.add(new FSLineStyle(coder));
+			lineStyles.add(new FSLineStyle(coder, context));
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
+		context.arrayExtended = true;
 
 		int bytesDecoded = (coder.getPointer() - start) &gt;&gt; 3;
 
-		if (coder.context[FSCoder.DecodeShapes] == 1)
-			shape = new FSShape(coder);
+		if (context.decodeShapes)
+			shape = new FSShape(coder, context);
 		else
-			shape = new FSShape(coder, length - bytesDecoded);
+			shape = new FSShape(coder, context, length - bytesDecoded);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
+		context.arrayExtended = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineShape3.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineShape3.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineShape3.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -154,10 +154,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineShape3(FSCoder coder)
+	public FSDefineShape3(FSCoder coder, FSContext context)
 	{
 		super(DefineShape3, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -383,54 +383,54 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		length += bounds.length(coder);
+		length += bounds.length(context);
 
 		length += (fillStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
 		length += (lineStyles.size() &gt;= 255) ? 3 : 1;
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			length += styleIterator.next().length(coder);
+			length += styleIterator.next().length(context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		length += shape.length(coder);
+		length += shape.length(context);
 
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
+		context.fillSize = 0;
+		context.lineSize = 0;
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.ArrayCountExtended] = 0;
+		context.transparent = false;
+		context.arrayExtended = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 		int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		bounds.encode(coder);
+		bounds.encode(coder, context);
 
 		if (fillStyles.size() &gt;= 255)
 		{
@@ -443,7 +443,7 @@
 
 		for (Iterator&lt;FSFillStyle&gt; styleIterator = fillStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
 		if (lineStyles.size() &gt;= 255)
 		{
@@ -456,32 +456,32 @@
 
 		for (Iterator&lt;FSLineStyle&gt; styleIterator = lineStyles.iterator(); styleIterator
 						.hasNext();)
-			styleIterator.next().encode(coder);
+			styleIterator.next().encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
-		coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-		coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+		context.arrayExtended = true;
+		context.fillSize = numberOfFillBits;
+		context.lineSize = numberOfLineBits;
 
-		shape.encode(coder);
+		shape.encode(coder, context);
 
-		coder.context[FSCoder.ArrayCountExtended] = 0;
-		coder.context[FSCoder.NumberOfFillBits] = 0;
-		coder.context[FSCoder.NumberOfLineBits] = 0;
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.arrayExtended = false;
+		context.fillSize = 0;
+		context.lineSize = 0;
+		context.transparent = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int fillStyleCount = 0;
 		int lineStyleCount = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer() - 16; // account for identifier
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 		fillStyleCount = coder.readByte();
 
 		if (fillStyleCount == 0xFF)
@@ -496,25 +496,25 @@
 			switch (coder.scanWord(1, false))
 			{
 				case FSFillStyle.Solid:
-					fillStyles.add(new FSSolidFill(coder));
+					fillStyles.add(new FSSolidFill(coder, context));
 					break;
 				case FSFillStyle.Linear:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Radial:
-					fillStyles.add(new FSGradientFill(coder));
+					fillStyles.add(new FSGradientFill(coder, context));
 					break;
 				case FSFillStyle.Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Tiled:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				case FSFillStyle.Unsmoothed_Clipped:
-					fillStyles.add(new FSBitmapFill(coder));
+					fillStyles.add(new FSBitmapFill(coder, context));
 					break;
 				default:
 					break;
@@ -529,18 +529,18 @@
 		lineStyles = new ArrayList(lineStyleCount);
 
 		for (int i = 0; i &lt; lineStyleCount; i++)
-			lineStyles.add(new FSLineStyle(coder));
+			lineStyles.add(new FSLineStyle(coder, context));
 
-		coder.context[FSCoder.ArrayCountExtended] = 1;
+		context.arrayExtended = true;
 
 		int bytesDecoded = (coder.getPointer() - start) &gt;&gt; 3;
 
-		if (coder.context[FSCoder.DecodeShapes] == 1)
-			shape = new FSShape(coder);
+		if (context.decodeShapes)
+			shape = new FSShape(coder, context);
 		else
-			shape = new FSShape(coder, length - bytesDecoded);
+			shape = new FSShape(coder, context, length - bytesDecoded);
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.ArrayCountExtended] = 0;
+		context.transparent = false;
+		context.arrayExtended = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineSound.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineSound.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineSound.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -167,10 +167,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineSound(FSCoder coder)
+	public FSDefineSound(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DefineSound, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -409,9 +409,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 5;
 		length += soundData.length;
@@ -419,9 +419,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(format, 4);
 
@@ -447,9 +447,9 @@
 		coder.writeBytes(soundData);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		format = coder.readBits(4, false);
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineText.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineText.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineText.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -164,10 +164,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineText(FSCoder coder)
+	public FSDefineText(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DefineText, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -349,62 +349,62 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits();
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits();
+		context.glyphSize = glyphBits();
+		context.advanceSize = advanceBits();
 
-		length += bounds.length(coder);
-		length += transform.length(coder);
+		length += bounds.length(context);
+		length += transform.length(context);
 		length += 2;
 
 		for (Iterator&lt;FSText&gt; recordIterator = objects.iterator(); recordIterator.hasNext();)
-			length += recordIterator.next().length(coder);
+			length += recordIterator.next().length(context);
 
 		length += 1;
 
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits();
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits();
+		context.glyphSize = glyphBits();
+		context.advanceSize = advanceBits();
 
-		bounds.encode(coder);
-		transform.encode(coder);
+		bounds.encode(coder, context);
+		transform.encode(coder, context);
 
-		coder.writeWord(coder.context[FSCoder.NumberOfGlyphBits], 1);
-		coder.writeWord(coder.context[FSCoder.NumberOfAdvanceBits], 1);
+		coder.writeWord(context.glyphSize, 1);
+		coder.writeWord(context.advanceSize, 1);
 
 		for (Iterator&lt;FSText&gt; recordIterator = objects.iterator(); recordIterator.hasNext();)
-			recordIterator.next().encode(coder);
+			recordIterator.next().encode(coder, context);
 
 		coder.writeWord(0, 1);
 
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int glyphBits = 0;
 		int advanceBits = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		// Mark the start of the tag body
 
 		/* location */coder.getPointer();
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 
 		// This code is used to get round a bug in Flash - sometimes 16,
 		// 8-bit zeroes are written out before the transform. The root
@@ -435,13 +435,13 @@
 
 		// Back to reading the rest of the tag
 
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 
 		glyphBits = coder.readByte();
 		advanceBits = coder.readByte();
 
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits;
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits;
+		context.glyphSize = glyphBits;
+		context.advanceSize = advanceBits;
 
 		/*
 		 * Set the instance variable directly since Flash files can contain
@@ -451,12 +451,12 @@
 		objects = new ArrayList();
 
 		while (coder.scanBits(8, false) != 0)
-			objects.add(new FSText(coder));
+			objects.add(new FSText(coder, context));
 
 		coder.readBits(8, false);
 
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 	}
 
 	private int glyphBits()

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineText2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineText2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineText2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -165,10 +165,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineText2(FSCoder coder)
+	public FSDefineText2(FSCoder coder, FSContext context)
 	{
 		super(DefineText2, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -350,67 +350,67 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits();
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits();
+		context.transparent = true;
+		context.glyphSize = glyphBits();
+		context.advanceSize = advanceBits();
 
-		length += bounds.length(coder);
-		length += transform.length(coder);
+		length += bounds.length(context);
+		length += transform.length(context);
 		length += 2;
 
 		for (Iterator&lt;Codeable&gt; recordIterator = objects.iterator(); recordIterator
 						.hasNext();)
-			length += recordIterator.next().length(coder);
+			length += recordIterator.next().length(context);
 
 		length += 1;
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.transparent = false;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits();
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits();
+		context.transparent = true;
+		context.glyphSize = glyphBits();
+		context.advanceSize = advanceBits();
 
-		bounds.encode(coder);
-		transform.encode(coder);
+		bounds.encode(coder, context);
+		transform.encode(coder, context);
 
-		coder.writeWord(coder.context[FSCoder.NumberOfGlyphBits], 1);
-		coder.writeWord(coder.context[FSCoder.NumberOfAdvanceBits], 1);
+		coder.writeWord(context.glyphSize, 1);
+		coder.writeWord(context.advanceSize, 1);
 
 		for (Iterator&lt;Codeable&gt; recordIterator = objects.iterator(); recordIterator.hasNext();)
-			recordIterator.next().encode(coder);
+			recordIterator.next().encode(coder, context);
 
 		coder.writeWord(0, 1);
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.transparent = false;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int glyphBits = 0;
 		int advanceBits = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		// Mark the start of the tag body
 
 		/* location */coder.getPointer();
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 
 		// This code is used to get round a bug in Flash - sometimes 16,
 		// 8-bit zeroes are written out before the transform. The root
@@ -441,14 +441,14 @@
 
 		// Back to reading the rest of the tag
 
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 
 		glyphBits = coder.readByte();
 		advanceBits = coder.readByte();
 
-		coder.context[FSCoder.TransparentColors] = 1;
-		coder.context[FSCoder.NumberOfGlyphBits] = glyphBits;
-		coder.context[FSCoder.NumberOfAdvanceBits] = advanceBits;
+		context.transparent = true;
+		context.glyphSize = glyphBits;
+		context.advanceSize = advanceBits;
 
 		/*
 		 * Set the instance variable directly since Flash files can contain
@@ -458,13 +458,13 @@
 		objects = new ArrayList();
 
 		while (coder.scanBits(8, false) != 0)
-			objects.add(new FSText(coder));
+			objects.add(new FSText(coder, context));
 
 		coder.readBits(8, false);
 
-		coder.context[FSCoder.TransparentColors] = 0;
-		coder.context[FSCoder.NumberOfGlyphBits] = 0;
-		coder.context[FSCoder.NumberOfAdvanceBits] = 0;
+		context.transparent = false;
+		context.glyphSize = 0;
+		context.advanceSize = 0;
 	}
 
 	private int glyphBits()

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineTextField.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineTextField.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineTextField.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -370,10 +370,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineTextField(FSCoder coder)
+	public FSDefineTextField(FSCoder coder, FSContext context)
 	{
 		super(DefineTextField, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -1108,43 +1108,43 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		boolean _containsFont = containsFont();
 		boolean _containsColor = containsColor();
 		boolean _containsMaxLength = containsMaxLength();
 		boolean _containsText = containsText();
 
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		length += bounds.length(coder);
+		length += bounds.length(context);
 		length += 2;
 		length += (_containsFont) ? 4 : 0;
-		length += (_containsColor) ? color.length(coder) : 0;
+		length += (_containsColor) ? color.length(context) : 0;
 		length += (_containsMaxLength) ? 2 : 0;
 		length += (containsLayoutInfo()) ? 9 : 0;
-		length += coder.strlen(variableName, true);
-		length += (_containsText) ? coder.strlen(initialText, true) : 0;
+		length += FSCoder.strlen(variableName, true);
+		length += (_containsText) ? FSCoder.strlen(initialText, true) : 0;
 
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		boolean _containsFont = containsFont();
 		boolean _containsColor = containsColor();
 		boolean _containsMaxLength = containsMaxLength();
 		boolean _containsText = containsText();
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		bounds.encode(coder);
+		bounds.encode(coder, context);
 		coder.writeBits(_containsText ? 1 : 0, 1);
 		coder.writeBits(wordWrapped ? 1 : 0, 1);
 		coder.writeBits(multiline ? 1 : 0, 1);
@@ -1169,7 +1169,7 @@
 		}
 
 		if (_containsColor)
-			color.encode(coder);
+			color.encode(coder, context);
 
 		if (_containsMaxLength)
 			coder.writeWord(maxLength, 2);
@@ -1202,10 +1202,10 @@
 			coder.writeString(initialText);
 			coder.writeWord(0, 1);
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		boolean _containsFont = false;
 		boolean _containsColor = false;
@@ -1213,11 +1213,11 @@
 		boolean _containsText = false;
 		boolean _containsLayout = false;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
-		bounds = new FSBounds(coder);
+		bounds = new FSBounds(coder, context);
 
 		_containsText = coder.readBits(1, false) != 0 ? true : false;
 		wordWrapped = coder.readBits(1, false) != 0 ? true : false;
@@ -1243,7 +1243,7 @@
 		}
 
 		if (_containsColor)
-			color = new FSColor(coder);
+			color = new FSColor(coder, context);
 
 		if (_containsMaxLength)
 			maxLength = coder.readWord(2, false);
@@ -1262,7 +1262,7 @@
 		if (_containsText)
 			initialText = coder.readString();
 
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 
 	private boolean containsColor()

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDefineVideo.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDefineVideo.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDefineVideo.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -159,10 +159,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDefineVideo(FSCoder coder)
+	public FSDefineVideo(FSCoder coder, FSContext context)
 	{
 		super(DefineVideo, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -398,18 +398,18 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 8;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(frameCount, 2);
 		coder.writeWord(width, 2);
@@ -420,9 +420,9 @@
 		coder.writeWord(codec, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		frameCount = coder.readWord(2, false);
 		width = coder.readWord(2, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSDoAction.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSDoAction.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSDoAction.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -116,10 +116,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSDoAction(FSCoder coder)
+	public FSDoAction(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.DoAction);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -295,9 +295,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		if (actions != null)
 		{
@@ -308,7 +308,7 @@
 			{
 				currentAction = (FSActionObject) actions.get(i);
 
-				length += currentAction.length(coder);
+				length += currentAction.length(context);
 				length += (currentAction.getType() &gt; 128) ? 3 : 1;
 			}
 
@@ -329,9 +329,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		if (actions != null)
 		{
@@ -346,17 +346,17 @@
 								+ ((action.getType() &gt; 128) ? 24 : 8);
 				int next = start + (action.getLength() &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 
 				int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = objStart &gt;&gt;&gt; 3;
+					context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 				coder.setPointer(next);
 			}
@@ -377,11 +377,11 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
-		if (coder.context[FSCoder.DecodeActions] == 1)
+		if (context.decodeActions)
 		{
 			actions = new ArrayList();
 
@@ -392,7 +392,7 @@
 			{
 				start = coder.getPointer();
 
-				actions.add(FSActionObject.decodeAction(coder));
+				actions.add(FSActionObject.decodeAction(coder, context));
 				len -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 			}
 		} else

Modified: dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -78,10 +78,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSEnableDebugger(FSCoder coder)
+	public FSEnableDebugger(FSCoder coder, FSContext context)
 	{
 		super(EnableDebugger);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -157,27 +157,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2 + FSCoder.strlen(password, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(0, 2);
 		coder.writeString(password);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		coder.readWord(2, false);
 		password = coder.readString();

Modified: dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSEnableDebugger2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -79,10 +79,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSEnableDebugger2(FSCoder coder)
+	public FSEnableDebugger2(FSCoder coder, FSContext context)
 	{
 		super(EnableDebugger2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -158,27 +158,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2 + FSCoder.strlen(password, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(0, 2);
 		coder.writeString(password);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		coder.readWord(2, false);
 		password = coder.readString();

Modified: dev/dev-2-4/src/com/flagstone/transform/FSEnvelope.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSEnvelope.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSEnvelope.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -98,9 +98,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSEnvelope(FSCoder coder)
+	public FSEnvelope(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -263,20 +263,20 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 8;
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(mark, 4);
 		coder.writeWord(left, 2);
 		coder.writeWord(right, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		mark = coder.readWord(4, false);
 		left = coder.readWord(2, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSExceptionHandler.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSExceptionHandler.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSExceptionHandler.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -139,10 +139,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSExceptionHandler(FSCoder coder)
+	public FSExceptionHandler(FSCoder coder, FSContext context)
 	{
 		super(ExceptionHandler);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -457,9 +457,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 7;
 		length += (variable != null) ? FSCoder.strlen(variable, true) : 1;
@@ -475,9 +475,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(0, 5);
 		coder.writeBits(variable == null ? 1 : 0, 1);
@@ -493,14 +493,14 @@
 		else
 			coder.writeWord(register, 1);
 
-		FSActionObject.encode(coder, tryActions);
-		FSActionObject.encode(coder, catchActions);
-		FSActionObject.encode(coder, finalActions);
+		FSActionObject.encode(coder, context, tryActions);
+		FSActionObject.encode(coder, context, catchActions);
+		FSActionObject.encode(coder, context, finalActions);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		coder.readBits(5, false);
 		boolean containsVariable = coder.readBits(1, false) != 1;
@@ -519,16 +519,16 @@
 			register = coder.readByte();
 		}
 
-		tryActions = FSActionObject.decodeActions(coder, tryLength);
+		tryActions = FSActionObject.decodeActions(coder, context, tryLength);
 
 		if (containsCatch)
 		{
-			catchActions = FSActionObject.decodeActions(coder, catchLength);
+			catchActions = FSActionObject.decodeActions(coder, context, catchLength);
 		}
 
 		if (containsFinal)
 		{
-			finalActions = FSActionObject.decodeActions(coder, finalLength);
+			finalActions = FSActionObject.decodeActions(coder, context, finalLength);
 		}
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSExport.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSExport.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSExport.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -104,10 +104,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSExport(FSCoder coder)
+	public FSExport(FSCoder coder, FSContext context)
 	{
 		super(Export);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -203,9 +203,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
@@ -219,9 +219,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(objects.size(), 2);
 
@@ -236,9 +236,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int count = coder.readWord(2, false);
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSFillStyle.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSFillStyle.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSFillStyle.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -59,7 +59,7 @@
 	/** Defines the type for a clipped bitmap fill style - added in Flash 7. */
 	public static final int Unsmoothed_Clipped = 67;
 
-	static FSFillStyle decodeStyle(FSCoder coder)
+	static FSFillStyle decodeStyle(FSCoder coder, FSContext context)
 	{
 		FSFillStyle style = null;
 
@@ -68,25 +68,25 @@
 		switch (type)
 		{
 			case Solid:
-				style = new FSSolidFill(coder);
+				style = new FSSolidFill(coder, context);
 				break;
 			case Linear:
-				style = new FSGradientFill(coder);
+				style = new FSGradientFill(coder, context);
 				break;
 			case Radial:
-				style = new FSGradientFill(coder);
+				style = new FSGradientFill(coder, context);
 				break;
 			case Tiled:
-				style = new FSBitmapFill(coder);
+				style = new FSBitmapFill(coder, context);
 				break;
 			case Clipped:
-				style = new FSBitmapFill(coder);
+				style = new FSBitmapFill(coder, context);
 				break;
 			case Unsmoothed_Tiled:
-				style = new FSBitmapFill(coder);
+				style = new FSBitmapFill(coder, context);
 				break;
 			case Unsmoothed_Clipped:
-				style = new FSBitmapFill(coder);
+				style = new FSBitmapFill(coder, context);
 				break;
 			default:
 				Integer key = new Integer(type);
@@ -97,7 +97,7 @@
 					{
 						Class&lt;FSFillStyle&gt; obj = table.get(key);
 						style = (FSFillStyle) obj.newInstance();
-						style.decode(coder);
+						style.decode(coder, context);
 					} catch (Exception e)
 					{
 						style = null;
@@ -117,8 +117,8 @@
 	 * To add support for a new data structure simply sub-class FSFillStyle and
 	 * implement the following methods:
 	 * 
-	 * public int length(FSCoder coder) public void encode(FSCoder coder) public
-	 * void decode(FSCoder coder)
+	 * public int length(FSContext context) public void encode(FSCoder coder, FSContext context) public
+	 * void decode(FSCoder coder, FSContext context)
 	 * 
 	 * In addition you must implement the nullary or empty constructor so that
 	 * the object can be instantiated correctly.
@@ -223,19 +223,19 @@
 		return result;
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 1;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeByte(type);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		type = coder.readByte();
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSFontInfo.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSFontInfo.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSFontInfo.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -157,10 +157,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSFontInfo(FSCoder coder)
+	public FSFontInfo(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.FontInfo);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -422,12 +422,12 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
-		length += coder.strlen(name, false);
+		length += FSCoder.strlen(name, false);
 
 		_containsWideCodes = false;
 
@@ -442,12 +442,12 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
-		coder.writeWord(coder.strlen(name, false), 1);
+		coder.writeWord(FSCoder.strlen(name, false), 1);
 		coder.writeString(name);
 		coder.writeBits(0, 2);
 		coder.writeBits(small ? 1 : 0, 1);
@@ -461,13 +461,13 @@
 							_containsWideCodes ? 2 : 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int nameLength = 0;
 
 		codes = new ArrayList();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
 		nameLength = coder.readByte();

Modified: dev/dev-2-4/src/com/flagstone/transform/FSFontInfo2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSFontInfo2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSFontInfo2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -148,10 +148,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSFontInfo2(FSCoder coder)
+	public FSFontInfo2(FSCoder coder, FSContext context)
 	{
 		super(FontInfo2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -446,24 +446,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
-		length += coder.strlen(name, false);
+		length += FSCoder.strlen(name, false);
 		length += 1;
 		length += codes.size() * 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
-		coder.writeWord(coder.strlen(name, false), 1);
+		coder.writeWord(FSCoder.strlen(name, false), 1);
 		coder.writeString(name);
 		coder.writeBits(0, 2);
 		coder.writeBits(small ? 1 : 0, 1);
@@ -477,13 +477,13 @@
 			coder.writeWord(((Integer) codesIterator.next()).intValue(), 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int nameLength = 0;
 
 		codes = new ArrayList();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
 		nameLength = coder.readByte();

Modified: dev/dev-2-4/src/com/flagstone/transform/FSFrameLabel.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSFrameLabel.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSFrameLabel.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -211,10 +211,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSFrameLabel(FSCoder coder)
+	public FSFrameLabel(FSCoder coder, FSContext context)
 	{
 		super(FrameLabel);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -364,11 +364,11 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += coder.strlen(label, true);
+		length += FSCoder.strlen(label, true);
 
 		// Flash 6
 		length += anchor ? 1 : 0;
@@ -377,9 +377,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeString(label);
 		coder.writeWord(0, 1);
 
@@ -389,9 +389,9 @@
 		// End Flash 6
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int start = coder.getPointer();
 		int strlen = 0;

Modified: dev/dev-2-4/src/com/flagstone/transform/FSFree.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSFree.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSFree.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -71,10 +71,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSFree(FSCoder coder)
+	public FSFree(FSCoder coder, FSContext context)
 	{
 		super(Free);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -151,24 +151,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(identifier, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		identifier = coder.readWord(2, false);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGetUrl.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGetUrl.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGetUrl.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -182,10 +182,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGetUrl(FSCoder coder)
+	public FSGetUrl(FSCoder coder, FSContext context)
 	{
 		super(FSActionObject.GetUrl);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -303,9 +303,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += FSCoder.strlen(url, true);
 		length += FSCoder.strlen(target, true);
@@ -313,9 +313,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeString(url);
 		coder.writeWord(0, 1);
@@ -324,9 +324,9 @@
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		url = coder.readString();
 		target = coder.readString();
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGetUrl2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGetUrl2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGetUrl2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -288,10 +288,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGetUrl2(FSCoder coder)
+	public FSGetUrl2(FSCoder coder, FSContext context)
 	{
 		super(GetUrl2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -362,24 +362,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(requestType, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		requestType = coder.readByte();
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -109,10 +109,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGotoFrame(FSCoder coder)
+	public FSGotoFrame(FSCoder coder, FSContext context)
 	{
 		super(GotoFrame);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -184,24 +184,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(frameNumber, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		frameNumber = coder.readWord(2, false);
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGotoFrame2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -175,10 +175,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGotoFrame2(FSCoder coder)
+	public FSGotoFrame2(FSCoder coder, FSContext context)
 	{
 		super(GotoFrame2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -310,18 +310,18 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1 + ((frameOffset &gt; 0) ? 2 : 0);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(0, 6);
 		coder.writeBits(frameOffset != 0 ? 1 : 0, 1);
@@ -333,11 +333,11 @@
 		// End Flash 5
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		boolean containsOffset = false;
 
-		super.decode(coder);
+		super.decode(coder, context);
 		coder.readBits(6, false);
 		containsOffset = coder.readBits(1, false) != 0 ? true : false;
 		playFrame = coder.readBits(1, false) != 0 ? true : false;

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGotoLabel.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGotoLabel.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGotoLabel.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -109,10 +109,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGotoLabel(FSCoder coder)
+	public FSGotoLabel(FSCoder coder, FSContext context)
 	{
 		super(GotoLabel);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -182,26 +182,26 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += coder.strlen(label, true);
+		length += FSCoder.strlen(label, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeString(label);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		label = coder.readString();
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGradient.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGradient.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGradient.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -94,9 +94,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGradient(FSCoder coder)
+	public FSGradient(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -244,24 +244,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 1;
 
-		length += color.length(coder);
+		length += color.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeByte(ratio);
-		color.encode(coder);
+		color.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		ratio = coder.readByte();
-		color = new FSColor(coder);
+		color = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSGradientFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSGradientFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSGradientFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -187,10 +187,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSGradientFill(FSCoder coder)
+	public FSGradientFill(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -338,35 +338,35 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
+		int length = super.length(context);
 
-		length += transform.length(coder);
+		length += transform.length(context);
 		length += 1;
 
 		for (Iterator&lt;FSGradient&gt;i=gradients.iterator(); i.hasNext();)
-			length += i.next().length(coder);
+			length += i.next().length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
-		transform.encode(coder);
+		transform.encode(coder, context);
 		coder.writeWord(gradients.size(), 1);
 
 		for (Iterator&lt;FSGradient&gt; i = gradients.iterator(); i.hasNext();)
-			i.next().encode(coder);
+			i.next().encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 
 		/*
 		 * A maximum of 8 gradients can be defined. A mask is applied to the
@@ -382,6 +382,6 @@
 		gradients = new ArrayList&lt;FSGradient&gt;(count);
 
 		for (int i = 0; i &lt; count; i++)
-			gradients.add(new FSGradient(coder));
+			gradients.add(new FSGradient(coder, context));
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSIf.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSIf.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSIf.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -110,10 +110,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSIf(FSCoder coder)
+	public FSIf(FSCoder coder, FSContext context)
 	{
 		super(If);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -192,24 +192,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(offset, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		offset = coder.readWord(2, true);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSImport.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSImport.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSImport.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -125,10 +125,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSImport(FSCoder coder)
+	public FSImport(FSCoder coder, FSContext context)
 	{
 		super(Import);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -263,11 +263,11 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += coder.strlen(url, true);
+		length += FSCoder.strlen(url, true);
 		length += 2;
 
 		for (Enumeration e = objects.keys(); e.hasMoreElements();)
@@ -275,15 +275,15 @@
 			String name = (String) (objects.get(e.nextElement()));
 
 			length += 2;
-			length += coder.strlen(name, true);
+			length += FSCoder.strlen(name, true);
 		}
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeString(url);
 		coder.writeWord(0, 1);
@@ -301,9 +301,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		url = coder.readString();
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSInitialize.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSInitialize.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSInitialize.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -115,10 +115,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSInitialize(FSCoder coder)
+	public FSInitialize(FSCoder coder, FSContext context)
 	{
 		super(Initialize);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -323,9 +323,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
@@ -337,7 +337,7 @@
 			{
 				currentAction = (FSActionObject) i.next();
 
-				length += currentAction.length(coder);
+				length += currentAction.length(context);
 				length += (currentAction.getType() &gt; 128) ? 3 : 1;
 			}
 
@@ -359,9 +359,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
 
@@ -379,18 +379,18 @@
 								+ ((action.getType() &gt; 128) ? 24 : 8);
 				int next = start + (length &lt;&lt; 3);
 
-				action.encode(coder);
+				action.encode(coder, context);
 				coder.setPointer(next);
 
 				int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 				if (delta != 0)
 				{
-					coder.context[FSCoder.CodingError] = 1;
-					coder.context[FSCoder.TypeInError] = action.getType();
-					coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-					coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-					coder.context[FSCoder.Delta] = delta;
+					context.codingError = true;
+					context.typeInError = action.getType();
+					context.startOfError = objStart &gt;&gt;&gt; 3;
+					context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+					context.delta = delta;
 				}
 			}
 
@@ -410,13 +410,13 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
 
-		if (coder.context[FSCoder.DecodeActions] == 1)
+		if (context.decodeActions)
 		{
 			actions = new ArrayList();
 
@@ -427,7 +427,7 @@
 			{
 				start = coder.getPointer();
 
-				actions.add(FSActionObject.decodeAction(coder));
+				actions.add(FSActionObject.decodeAction(coder, context));
 				len -= (coder.getPointer() - start) &gt;&gt;&gt; 3;
 			}
 		} else

Modified: dev/dev-2-4/src/com/flagstone/transform/FSJPEGEncodingTable.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSJPEGEncodingTable.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSJPEGEncodingTable.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -115,10 +115,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSJPEGEncodingTable(FSCoder coder)
+	public FSJPEGEncodingTable(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.JPEGTables);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -224,24 +224,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += encodingTable.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeBytes(encodingTable);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		
 		byte[] data = new byte[length];
 		coder.readBytes(data);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSJump.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSJump.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSJump.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -95,10 +95,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSJump(FSCoder coder)
+	public FSJump(FSCoder coder, FSContext context)
 	{
 		super(Jump);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -174,24 +174,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(offset, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		offset = coder.readWord(2, true);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSKerning.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSKerning.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSKerning.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -92,9 +92,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSKerning(FSCoder coder)
+	public FSKerning(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -264,27 +264,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = (coder.context[FSCoder.WideCodes] != 0) ? 4 : 2;
+		int length = (context.wideCodes) ? 4 : 2;
 
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		int numberOfBytes = (coder.context[FSCoder.WideCodes] != 0) ? 2 : 1;
+		int numberOfBytes = (context.wideCodes) ? 2 : 1;
 
 		coder.writeWord(leftIndex, numberOfBytes);
 		coder.writeWord(rightIndex, numberOfBytes);
 		coder.writeWord(adjustment, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		int numberOfBytes = (coder.context[FSCoder.WideCodes] != 0) ? 2 : 1;
+		int numberOfBytes = (context.wideCodes) ? 2 : 1;
 
 		leftIndex = coder.readWord(numberOfBytes, false);
 		rightIndex = coder.readWord(numberOfBytes, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSLimitScript.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSLimitScript.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSLimitScript.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -87,10 +87,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSLimitScript(FSCoder coder)
+	public FSLimitScript(FSCoder coder, FSContext context)
 	{
 		super(LimitScript);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -200,26 +200,26 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(depth, 2);
 		coder.writeWord(timeout, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		depth = coder.readWord(2, false);
 		timeout = coder.readWord(2, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSLine.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSLine.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSLine.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -90,9 +90,9 @@
 	 * @param coder
 	 *            an FSCoder object containing the encoded colour transform.
 	 */
-	public FSLine(FSCoder coder)
+	public FSLine(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -234,7 +234,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		vertical = x == 0;
 		general = x != 0 &amp;&amp; y != 0;
@@ -251,12 +251,12 @@
 			numberOfBits += 1 + size;
 		}
 
-		coder.context[FSCoder.NumberOfShapeBits] += numberOfBits;
+		context.shapeSize += numberOfBits;
 
 		return numberOfBits;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeBits(3, 2);
 		coder.writeBits(size - 2, 4);
@@ -273,7 +273,7 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		coder.adjustPointer(2); // shape and edge
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSLineStyle.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSLineStyle.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSLineStyle.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -131,9 +131,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSLineStyle(FSCoder coder)
+	public FSLineStyle(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -267,24 +267,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 2;
 
-		length += color.length(coder);
+		length += color.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(width, 2);
-		color.encode(coder);
+		color.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		width = coder.readWord(2, false);
-		color = new FSColor(coder);
+		color = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMorphBitmapFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMorphBitmapFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMorphBitmapFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -119,10 +119,10 @@
 	 *            an FSCoder object containing an FSMorphBitmapFill encoded as
 	 *            binary data.
 	 */
-	public FSMorphBitmapFill(FSCoder coder)
+	public FSMorphBitmapFill(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -282,30 +282,30 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
+		int length = super.length(context);
 
 		length += 2;
-		length += start.length(coder);
-		length += end.length(coder);
+		length += start.length(context);
+		length += end.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(identifier, 2);
-		start.encode(coder);
-		end.encode(coder);
+		start.encode(coder, context);
+		end.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		identifier = coder.readWord(2, false);
-		start.decode(coder);
-		end.decode(coder);
+		start.decode(coder, context);
+		end.decode(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMorphGradient.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMorphGradient.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMorphGradient.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -113,9 +113,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSMorphGradient(FSCoder coder)
+	public FSMorphGradient(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -325,29 +325,29 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 2;
 
-		length += startColor.length(coder);
-		length += endColor.length(coder);
+		length += startColor.length(context);
+		length += endColor.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(startRatio, 1);
-		startColor.encode(coder);
+		startColor.encode(coder, context);
 		coder.writeWord(endRatio, 1);
-		endColor.encode(coder);
+		endColor.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		startRatio = coder.readByte();
-		startColor = new FSColor(coder);
+		startColor = new FSColor(coder, context);
 		endRatio = coder.readByte();
-		endColor = new FSColor(coder);
+		endColor = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMorphGradientFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMorphGradientFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMorphGradientFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -203,10 +203,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSMorphGradientFill(FSCoder coder)
+	public FSMorphGradientFill(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -393,46 +393,46 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
+		int length = super.length(context);
 
-		length += start.length(coder);
-		length += end.length(coder);
+		length += start.length(context);
+		length += end.length(context);
 		length += 1;
 
 		for (Iterator&lt;FSMorphGradient&gt; i = gradients.iterator(); i.hasNext();)
-			length += i.next().length(coder);
+			length += i.next().length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		
-		start.encode(coder);
-		end.encode(coder);
+		start.encode(coder, context);
+		end.encode(coder, context);
 		
 		coder.writeByte(gradients.size());
 
 		for (Iterator&lt;FSMorphGradient&gt; i = gradients.iterator(); i.hasNext();)
-			i.next().encode(coder);
+			i.next().encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
-		start = new FSCoordTransform(coder);
-		end = new FSCoordTransform(coder);
+		start = new FSCoordTransform(coder, context);
+		end = new FSCoordTransform(coder, context);
 
 		int count = coder.readByte();
 
 		gradients = new ArrayList&lt;FSMorphGradient&gt;(count);
 
 		for (int i=0; i&lt;count; i++) {
-			gradients.add(new FSMorphGradient(coder));
+			gradients.add(new FSMorphGradient(coder, context));
 		}
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMorphLineStyle.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMorphLineStyle.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMorphLineStyle.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -96,9 +96,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSMorphLineStyle(FSCoder coder)
+	public FSMorphLineStyle(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -300,29 +300,29 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 4;
 
-		length += startColor.length(coder);
-		length += endColor.length(coder);
+		length += startColor.length(context);
+		length += endColor.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(startWidth, 2);
 		coder.writeWord(endWidth, 2);
-		startColor.encode(coder);
-		endColor.encode(coder);
+		startColor.encode(coder, context);
+		endColor.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		startWidth = coder.readWord(2, false);
 		endWidth = coder.readWord(2, false);
-		startColor = new FSColor(coder);
-		endColor = new FSColor(coder);
+		startColor = new FSColor(coder, context);
+		endColor = new FSColor(coder, context);
 	}
 }
\ No newline at end of file

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMorphSolidFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMorphSolidFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMorphSolidFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -96,10 +96,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSMorphSolidFill(FSCoder coder)
+	public FSMorphSolidFill(FSCoder coder, FSContext context)
 	{
 		super(Solid);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -220,27 +220,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
+		int length = super.length(context);
 
-		length += start.length(coder);
-		length += end.length(coder);
+		length += start.length(context);
+		length += end.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
-		start.encode(coder);
-		end.encode(coder);
+		super.encode(coder, context);
+		start.encode(coder, context);
+		end.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
-		start = new FSColor(coder);
-		end = new FSColor(coder);
+		super.decode(coder, context);
+		start = new FSColor(coder, context);
+		end = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMovie.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMovie.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMovie.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -581,6 +581,7 @@
 					IOException
 	{
 		FSCoder coder;
+		FSContext context = new FSContext();
 		FSMovieObject object;
 
 		if (bytes == null)
@@ -598,31 +599,31 @@
 		signature = coder.readString(3, &quot;UTF8&quot;);
 		version = coder.readByte();
 		length = coder.readWord(4, false);
-		frameSize = new FSBounds(coder);
+		frameSize = new FSBounds(coder, context);
 		frameRate = coder.readFixedWord(1, 1);
 		frameCount = coder.readWord(2, false);
 
-		coder.context[FSCoder.Version] = version;
-		coder.context[FSCoder.DecodeActions] = decodeActions ? 1 : 0;
-		coder.context[FSCoder.DecodeShapes] = decodeShapes ? 1 : 0;
-		coder.context[FSCoder.DecodeGlyphs] = decodeGlyphs ? 1 : 0;
+		context.version = version;
+		context.decodeActions = decodeActions;
+		context.decodeShapes = decodeShapes;
+		context.decodeGlyphs = decodeGlyphs;
 
-		while ((object = FSMovieObject.decodeObject(coder)) != null)
+		while ((object = FSMovieObject.decodeObject(coder, context)) != null)
 		{
 			objects.add(object);
 			
-			if (coder.context[FSCoder.Identifier] &gt; identifier) {
-				identifier = coder.context[FSCoder.Identifier];				
+			if (context.identifier &gt; identifier) {
+				identifier = context.identifier;				
 			}
 
-			if (coder.context[FSCoder.CodingError] == 1)
+			if (context.codingError)
 			{
 				throw new FSCoderException(
-								coder.context[FSCoder.TypeInError],
-								coder.context[FSCoder.StartOfError],
-								coder.context[FSCoder.ExpectedLength],
-								coder.context[FSCoder.Delta],
-								(coder.context[FSCoder.Delta] &gt; 0) ? &quot;ObjectOverflow&quot;
+								context.typeInError,
+								context.startOfError,
+								context.expectedLength,
+								context.delta,
+								(context.delta &gt; 0) ? &quot;ObjectOverflow&quot;
 												: &quot;ObjectUnderflow&quot;);
 			}
 		}
@@ -669,30 +670,31 @@
 	public byte[] encode() throws IOException
 	{
 		FSCoder coder = new FSCoder(FSCoder.LITTLE_ENDIAN, new byte[0]);
+		FSContext context = new FSContext();
 
-		coder.context[FSCoder.Version] = version;
+		context.version = version;
 
-		length(coder);
+		length(coder, context);
 
 		coder.setData(FSCoder.LITTLE_ENDIAN, new byte[length]);
 
 		coder.writeString(signature, &quot;UTF8&quot;);
 		coder.writeWord(version, 1);
 		coder.writeWord(length, 4);
-		frameSize.encode(coder);
+		frameSize.encode(coder, context);
 		coder.writeFixedWord(frameRate, 1, 1);
 		coder.writeWord(frameCount, 2);
 
-		FSMovieObject.encode(coder, objects);
+		FSMovieObject.encode(coder, context, objects);
 
-		if (coder.context[FSCoder.CodingError] == 1)
+		if (context.codingError)
 		{
 			throw new FSCoderException(
-							coder.context[FSCoder.TypeInError],
-							coder.context[FSCoder.StartOfError],
-							coder.context[FSCoder.ExpectedLength],
-							coder.context[FSCoder.Delta],
-							(coder.context[FSCoder.Delta] &gt; 0) ? &quot;ObjectOverflow&quot;
+							context.typeInError,
+							context.startOfError,
+							context.expectedLength,
+							context.delta,
+							(context.delta &gt; 0) ? &quot;ObjectOverflow&quot;
 											: &quot;ObjectUnderflow&quot;);
 		}
 
@@ -800,11 +802,11 @@
 		return buffer.toString();
 	}
 
-	private int length(FSCoder coder)
+	private int length(FSCoder coder, FSContext context)
 	{
 		length = 14; // Includes End
-		length += frameSize.length(coder);
-		length += FSMovieObject.length(coder, objects);
+		length += frameSize.length(context);
+		length += FSMovieObject.length(context, objects);
 
 		frameCount = 0;
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSMovieObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSMovieObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSMovieObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -279,7 +279,7 @@
 		&quot;TabOrder&quot;,
 	};
 
-	static int length(FSCoder coder, ArrayList&lt;FSMovieObject&gt; array)
+	static int length(FSContext context, ArrayList&lt;FSMovieObject&gt; array)
 	{
 		FSMovieObject object;
 		int length = 0;
@@ -289,7 +289,7 @@
 		{
 			object = i.next();
 
-			length = object.length(coder);
+			length = object.length(context);
 			length += (object.extendLength || length &gt;= 63) ? 6 : 2;
 
 			total += length;
@@ -297,7 +297,7 @@
 		return total;
 	}
 
-	static void encode(FSCoder coder, ArrayList&lt;FSMovieObject&gt; array)
+	static void encode(FSCoder coder, FSContext context, ArrayList&lt;FSMovieObject&gt; array)
 	{
 		FSMovieObject object;
 		int start;
@@ -313,17 +313,17 @@
 			next += ((object.extendLength || object.length &gt;= 63) ? 48 : 16);
 			next += (object.length &lt;&lt; 3);
 
-			object.encode(coder);
+			object.encode(coder, context);
 
 			delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 			if (delta != 0)
 			{
-				coder.context[FSCoder.CodingError] = 1;
-				coder.context[FSCoder.TypeInError] = object.getType();
-				coder.context[FSCoder.StartOfError] = start &gt;&gt;&gt; 3;
-				coder.context[FSCoder.ExpectedLength] = (next - start) &gt;&gt;&gt; 3;
-				coder.context[FSCoder.Delta] = delta;
+				context.codingError = true;
+				context.typeInError = object.getType();
+				context.startOfError = start &gt;&gt;&gt; 3;
+				context.expectedLength = (next - start) &gt;&gt;&gt; 3;
+				context.delta = delta;
 				break;
 			}
 
@@ -331,7 +331,7 @@
 		}
 	}
 
-	static FSMovieObject decodeObject(FSCoder coder)
+	static FSMovieObject decodeObject(FSCoder coder, FSContext context)
 	{
 		FSMovieObject currentObject = null;
 
@@ -364,108 +364,108 @@
 				coder.setPointer(next);
 				break;
 			case DefineShape:
-				currentObject = new FSDefineShape(coder);
+				currentObject = new FSDefineShape(coder, context);
 				break;
 			case PlaceObject:
-				currentObject = new FSPlaceObject(coder);
+				currentObject = new FSPlaceObject(coder, context);
 				break;
 			case RemoveObject:
-				currentObject = new FSRemoveObject(coder);
+				currentObject = new FSRemoveObject(coder, context);
 				break;
 			case DefineJPEGImage:
-				currentObject = new FSDefineJPEGImage(coder);
+				currentObject = new FSDefineJPEGImage(coder, context);
 				break;
 			case DefineButton:
-				currentObject = new FSDefineButton(coder);
+				currentObject = new FSDefineButton(coder, context);
 				break;
 			case JPEGTables:
-				currentObject = new FSJPEGEncodingTable(coder);
+				currentObject = new FSJPEGEncodingTable(coder, context);
 				break;
 			case SetBackgroundColor:
-				currentObject = new FSSetBackgroundColor(coder);
+				currentObject = new FSSetBackgroundColor(coder, context);
 				break;
 			case DefineFont:
-				currentObject = new FSDefineFont(coder);
+				currentObject = new FSDefineFont(coder, context);
 				break;
 			case DefineText:
-				currentObject = new FSDefineText(coder);
+				currentObject = new FSDefineText(coder, context);
 				break;
 			case DoAction:
-				currentObject = new FSDoAction(coder);
+				currentObject = new FSDoAction(coder, context);
 				break;
 			case FontInfo:
-				currentObject = new FSFontInfo(coder);
+				currentObject = new FSFontInfo(coder, context);
 				break;
 			case DefineSound:
-				currentObject = new FSDefineSound(coder);
+				currentObject = new FSDefineSound(coder, context);
 				break;
 			case StartSound:
-				currentObject = new FSStartSound(coder);
+				currentObject = new FSStartSound(coder, context);
 				break;
 			case SoundStreamHead:
-				currentObject = new FSSoundStreamHead(coder);
+				currentObject = new FSSoundStreamHead(coder, context);
 				break;
 			case SoundStreamBlock:
-				currentObject = new FSSoundStreamBlock(coder);
+				currentObject = new FSSoundStreamBlock(coder, context);
 				break;
 			// Flash 2
 			case ButtonSound:
-				currentObject = new FSButtonSound(coder);
+				currentObject = new FSButtonSound(coder, context);
 				break;
 			case DefineImage:
-				currentObject = new FSDefineImage(coder);
+				currentObject = new FSDefineImage(coder, context);
 				break;
 			case DefineJPEGImage2:
-				currentObject = new FSDefineJPEGImage2(coder);
+				currentObject = new FSDefineJPEGImage2(coder, context);
 				break;
 			case DefineShape2:
-				currentObject = new FSDefineShape2(coder);
+				currentObject = new FSDefineShape2(coder, context);
 				break;
 			case ButtonColorTransform:
-				currentObject = new FSButtonColorTransform(coder);
+				currentObject = new FSButtonColorTransform(coder, context);
 				break;
 			case Protect:
-				currentObject = new FSProtect(coder);
+				currentObject = new FSProtect(coder, context);
 				break;
 			// Flash 3
 			case Free:
-				currentObject = new FSFree(coder);
+				currentObject = new FSFree(coder, context);
 				break;
 			case PlaceObject2:
-				currentObject = new FSPlaceObject2(coder);
+				currentObject = new FSPlaceObject2(coder, context);
 				break;
 			case RemoveObject2:
-				currentObject = new FSRemoveObject2(coder);
+				currentObject = new FSRemoveObject2(coder, context);
 				break;
 			case DefineShape3:
-				currentObject = new FSDefineShape3(coder);
+				currentObject = new FSDefineShape3(coder, context);
 				break;
 			case DefineText2:
-				currentObject = new FSDefineText2(coder);
+				currentObject = new FSDefineText2(coder, context);
 				break;
 			case DefineButton2:
-				currentObject = new FSDefineButton2(coder);
+				currentObject = new FSDefineButton2(coder, context);
 				break;
 			case DefineJPEGImage3:
-				currentObject = new FSDefineJPEGImage3(coder);
+				currentObject = new FSDefineJPEGImage3(coder, context);
 				break;
 			case DefineImage2:
-				currentObject = new FSDefineImage2(coder);
+				currentObject = new FSDefineImage2(coder, context);
 				break;
 			case DefineMovieClip:
-				currentObject = new FSDefineMovieClip(coder);
+				currentObject = new FSDefineMovieClip(coder, context);
 				break;
 			case FrameLabel:
-				currentObject = new FSFrameLabel(coder);
+				currentObject = new FSFrameLabel(coder, context);
 				break;
 			case SoundStreamHead2:
-				currentObject = new FSSoundStreamHead2(coder);
+				currentObject = new FSSoundStreamHead2(coder, context);
 				break;
 			case DefineMorphShape:
-				currentObject = new FSDefineMorphShape(coder);
+				currentObject = new FSDefineMorphShape(coder, context);
 				break;
 			case DefineFont2:
-				currentObject = new FSDefineFont2(coder);
+				currentObject = new FSDefineFont2(coder, context);
 				break;
 			// Flash 4
 			case PathsArePostscript:
@@ -473,49 +473,49 @@
 				coder.setPointer(next);
 				break;
 			case DefineTextField:
-				currentObject = new FSDefineTextField(coder);
+				currentObject = new FSDefineTextField(coder, context);
 				break;
 			case QuicktimeMovie:
-				currentObject = new FSQuicktimeMovie(coder);
+				currentObject = new FSQuicktimeMovie(coder, context);
 				break;
 			case SerialNumber:
-				currentObject = new FSSerialNumber(coder);
+				currentObject = new FSSerialNumber(coder, context);
 				break;
 			case DefineBitsPtr:
-				currentObject = new FSPointer(coder);
+				currentObject = new FSPointer(coder, context);
 				break;
 			// Flash 5
 			case EnableDebugger:
-				currentObject = new FSEnableDebugger(coder);
+				currentObject = new FSEnableDebugger(coder, context);
 				break;
 			case Export:
-				currentObject = new FSExport(coder);
+				currentObject = new FSExport(coder, context);
 				break;
 			case Import:
-				currentObject = new FSImport(coder);
+				currentObject = new FSImport(coder, context);
 				break;
 			// Flash 6
 			case Initialize:
-				currentObject = new FSInitialize(coder);
+				currentObject = new FSInitialize(coder, context);
 				break;
 			case DefineVideo:
-				currentObject = new FSDefineVideo(coder);
+				currentObject = new FSDefineVideo(coder, context);
 				break;
 			case VideoFrame:
-				currentObject = new FSVideoFrame(coder);
+				currentObject = new FSVideoFrame(coder, context);
 				break;
 			case FontInfo2:
-				currentObject = new FSFontInfo2(coder);
+				currentObject = new FSFontInfo2(coder, context);
 				break;
 			case EnableDebugger2:
-				currentObject = new FSEnableDebugger2(coder);
+				currentObject = new FSEnableDebugger2(coder, context);
 				break;
 			// Flash 7
 			case LimitScript:
-				currentObject = new FSLimitScript(coder);
+				currentObject = new FSLimitScript(coder, context);
 				break;
 			case TabOrder:
-				currentObject = new FSTabOrder(coder);
+				currentObject = new FSTabOrder(coder, context);
 				break;
 			default:
 				Integer key = new Integer(type);
@@ -526,15 +526,15 @@
 					{
 						Class&lt;FSMovieObject&gt; obj = table.get(key);
 						currentObject = (FSMovieObject) obj.newInstance();
-						currentObject.decode(coder);
+						currentObject.decode(coder, context);
 					} 
 					catch (Exception e)
 					{
-						currentObject = new FSUnknownObject(coder);
+						currentObject = new FSUnknownObject(coder, context);
 					}
 				} else
 				{
-					currentObject = new FSUnknownObject(coder);
+					currentObject = new FSUnknownObject(coder, context);
 				}
 				break;
 		}
@@ -543,11 +543,11 @@
 
 		if (delta != 0)
 		{
-			coder.context[FSCoder.CodingError] = 1;
-			coder.context[FSCoder.TypeInError] = currentObject.getType();
-			coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-			coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-			coder.context[FSCoder.Delta] = delta;
+			context.codingError = true;
+			context.typeInError = currentObject.getType();
+			context.startOfError = objStart &gt;&gt;&gt; 3;
+			context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+			context.delta = delta;
 		}
 
 		coder.setPointer(next);
@@ -564,8 +564,8 @@
 	 * To add support for a new data structure simply sub-class FSMovieObject
 	 * and implement the following methods:
 	 * 
-	 * public int length(FSCoder coder) public void encode(FSCoder coder) public
-	 * void decode(FSCoder coder)
+	 * public int length(FSContext context) public void encode(FSCoder coder, FSContext context) public
+	 * void decode(FSCoder coder, FSContext context)
 	 * 
 	 * In addition you must implement the nullary or empty constructor so that
 	 * the object can be instantiated correctly.
@@ -693,18 +693,18 @@
 		return name[type];
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		coder.context[FSCoder.Type] = type;
+		context.type = type;
 
 		length = 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		coder.context[FSCoder.Type] = type;
+		context.type = type;
 
 		if (extendLength == false &amp;&amp; length &lt; 63)
 		{
@@ -716,12 +716,12 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		type = coder.scanWord(2, false) &gt;&gt; 6;
 		length = coder.scanWord(2, false) &amp; 0x3F;
 
-		coder.context[FSCoder.Type] = type;
+		context.type = type;
 		coder.setPointer(coder.getPointer() + 16);
 
 		if (length == 0x3F)

Modified: dev/dev-2-4/src/com/flagstone/transform/FSNewFunction.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSNewFunction.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSNewFunction.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -195,10 +195,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSNewFunction(FSCoder coder)
+	public FSNewFunction(FSCoder coder, FSContext context)
 	{
 		super(NewFunction);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -416,9 +416,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += (name != null) ? FSCoder.strlen(name, true) : 1;
 		length += 2;
@@ -437,7 +437,7 @@
 		{
 			FSActionObject currentAction = (FSActionObject) actions.get(i);
 
-			actionsLength += currentAction.length(coder);
+			actionsLength += currentAction.length(context);
 			actionsLength += (currentAction.getType() &gt; 128) ? 3 : 1;
 		}
 		length += actionsLength;
@@ -445,7 +445,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(type, 1);
 		coder.writeWord(length - actionsLength, 2);
@@ -477,23 +477,23 @@
 							+ ((action.getType() &gt; 128) ? 24 : 8);
 			int next = start + (action.getLength() &lt;&lt; 3);
 
-			action.encode(coder);
+			action.encode(coder, context);
 			coder.setPointer(next);
 
 			int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 			if (delta != 0)
 			{
-				coder.context[FSCoder.CodingError] = 1;
-				coder.context[FSCoder.TypeInError] = action.getType();
-				coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-				coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-				coder.context[FSCoder.Delta] = delta;
+				context.codingError = true;
+				context.typeInError = action.getType();
+				context.startOfError = objStart &gt;&gt;&gt; 3;
+				context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+				context.delta = delta;
 			}
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int argumentCount = 0;
 		int bytesRead = 0;
@@ -501,7 +501,7 @@
 		arguments = new ArrayList();
 		actions = new ArrayList();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		name = coder.readString();
 
@@ -518,7 +518,7 @@
 
 		while (bytesRead &lt; actionsLength)
 		{
-			FSActionObject anAction = FSActionObject.decodeAction(coder);
+			FSActionObject anAction = FSActionObject.decodeAction(coder, context);
 
 			bytesRead += anAction.getLength()
 							+ ((anAction.getType() &gt;= 128) ? 3 : 1);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSNewFunction2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSNewFunction2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSNewFunction2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -307,10 +307,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSNewFunction2(FSCoder coder)
+	public FSNewFunction2(FSCoder coder, FSContext context)
 	{
 		super(NewFunction2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -589,15 +589,15 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += (name != null) ? FSCoder.strlen(name, true) : 1;
 		length += 5;
 
 		for (int i = 0; i &lt; arguments.size(); i++)
-			length += arguments.get(i).length(coder);
+			length += arguments.get(i).length(context);
 
 		length += 2;
 
@@ -609,7 +609,7 @@
 		{
 			currentAction =  i.next();
 
-			_actionsLength += currentAction.length(coder);
+			_actionsLength += currentAction.length(context);
 			_actionsLength += (currentAction.getType() &gt; 128) ? 3 : 1;
 		}
 		length += _actionsLength;
@@ -617,7 +617,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(type, 1);
 		coder.writeWord(length - _actionsLength, 2);
@@ -632,7 +632,7 @@
 		coder.writeBits(optimizations, 16);
 
 		for (Iterator&lt;FSRegisterVariable&gt; i=arguments.iterator(); i.hasNext();)
-			i.next().encode(coder);
+			i.next().encode(coder, context);
 
 		coder.writeWord(_actionsLength, 2);
 
@@ -645,23 +645,23 @@
 							+ ((action.getType() &gt; 128) ? 24 : 8);
 			int next = start + (action.getLength() &lt;&lt; 3);
 
-			action.encode(coder);
+			action.encode(coder, context);
 			coder.setPointer(next);
 
 			int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 			if (delta != 0)
 			{
-				coder.context[FSCoder.CodingError] = 1;
-				coder.context[FSCoder.TypeInError] = action.getType();
-				coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-				coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-				coder.context[FSCoder.Delta] = delta;
+				context.codingError = true;
+				context.typeInError = action.getType();
+				context.startOfError = objStart &gt;&gt;&gt; 3;
+				context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+				context.delta = delta;
 			}
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int argumentCount = 0;
 		int bytesRead = 0;
@@ -669,7 +669,7 @@
 		arguments = new ArrayList&lt;FSRegisterVariable&gt;();
 		actions = new ArrayList&lt;FSActionObject&gt;();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		name = coder.readString();
 		argumentCount = coder.readWord(2, false);
@@ -677,14 +677,14 @@
 		optimizations = coder.readBits(16, false);
 
 		for (int i = 0; i &lt; argumentCount; i++)
-			arguments.add(new FSRegisterVariable(coder));
+			arguments.add(new FSRegisterVariable(coder, context));
 
 		_actionsLength = coder.readWord(2, false);
 		length += _actionsLength;
 
 		while (bytesRead &lt; _actionsLength)
 		{
-			FSActionObject anAction = FSActionObject.decodeAction(coder);
+			FSActionObject anAction = FSActionObject.decodeAction(coder, context);
 
 			bytesRead += anAction.getLength() + ((anAction.getType() &gt;= 128) ? 3 : 1);
 			actions.add(anAction);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSPathsArePostscript.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSPathsArePostscript.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSPathsArePostscript.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -91,10 +91,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSPathsArePostscript(FSCoder coder)
+	public FSPathsArePostscript(FSCoder coder, FSContext context)
 	{
 		super(PathsArePostscript);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** Constructs an FSPathsArePostscript object. */
@@ -120,12 +120,12 @@
 		return &quot;FSPathsArePostscript&quot;;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		coder.context[FSCoder.Empty] = 1;
+		context.empty = true;
 
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.Empty] = 0;
+		context.empty = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -179,10 +179,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSPlaceObject(FSCoder coder)
+	public FSPlaceObject(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.PlaceObject);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -421,41 +421,41 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 		length += 4;
-		length += transform.length(coder);
-		length += (colorTransform != null) ? colorTransform.length(coder) : 0;
+		length += transform.length(context);
+		length += (colorTransform != null) ? colorTransform.length(context) : 0;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
 		coder.writeWord(layer, 2);
-		transform.encode(coder);
+		transform.encode(coder, context);
 
 		if (colorTransform != null)
-			colorTransform.encode(coder);
+			colorTransform.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int lengthRead = coder.getPointer();
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		identifier = coder.readWord(2, false);
 		layer = coder.readWord(2, false);
-		transform = new FSCoordTransform(coder);
+		transform = new FSCoordTransform(coder, context);
 
 		lengthRead = (coder.getPointer() - lengthRead) &gt;&gt; 3;
 
 		if (length &gt; lengthRead)
-			colorTransform = new FSColorTransform(coder);
+			colorTransform = new FSColorTransform(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSPlaceObject2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -365,10 +365,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSPlaceObject2(FSCoder coder)
+	public FSPlaceObject2(FSCoder coder, FSContext context)
 	{
 		super(PlaceObject2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -1114,32 +1114,32 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		length += 3;
 		length += (place == 2 || place == 3) ? 2 : 0;
-		length += (containsTransform()) ? transform.length(coder) : 0;
-		length += (containsColorTransform(coder)) ? colorTransform
-						.length(coder) : 0;
+		length += (containsTransform()) ? transform.length(context) : 0;
+		length += (containsColorTransform()) ? colorTransform
+						.length(context) : 0;
 		length += (containsRatio()) ? 2 : 0;
 		length += (containsClippingDepth()) ? 2 : 0;
 
-		length += containsName() ? coder.strlen(name, true) : 0;
+		length += containsName() ? FSCoder.strlen(name, true) : 0;
 
 		if (containsClipEvents())
 		{
 			if (clipEvents != null)
 			{
-				int eventSize = coder.context[FSCoder.Version] &gt; 5 ? 4 : 2;
+				int eventSize = context.version &gt; 5 ? 4 : 2;
 
 				length += 2 + eventSize;
 
 				for (Iterator i = clipEvents.iterator(); i.hasNext();)
-					length += ((FSClipEvent) i.next()).length(coder);
+					length += ((FSClipEvent) i.next()).length(context);
 
 				length += eventSize;
 			} else
@@ -1147,22 +1147,22 @@
 				length += encodedEvents.length;
 			}
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		coder.writeBits(containsClipEvents() ? 1 : 0, 1);
 		coder.writeBits(containsClippingDepth() ? 1 : 0, 1);
 		coder.writeBits(containsName() ? 1 : 0, 1);
 		coder.writeBits(containsRatio() ? 1 : 0, 1);
-		coder.writeBits(containsColorTransform(coder) ? 1 : 0, 1);
+		coder.writeBits(containsColorTransform() ? 1 : 0, 1);
 		coder.writeBits(containsTransform() ? 1 : 0, 1);
 		coder.writeBits(place, 2);
 		coder.writeWord(layer, 2);
@@ -1170,13 +1170,13 @@
 		if (place == 2 || place == 3)
 			coder.writeWord(identifier, 2);
 		if (containsTransform())
-			transform.encode(coder);
-		if (containsColorTransform(coder))
-			colorTransform.encode(coder);
+			transform.encode(coder, context);
+		if (containsColorTransform())
+			colorTransform.encode(coder, context);
 		if (containsRatio())
 			coder.writeWord((int) (ratio * 65535.0f), 2);
 
-		// if (coder.context[FSCoder.Version] &gt; 5)
+		// if (context.version &gt; 5)
 		// {
 		if (containsName())
 		{
@@ -1196,7 +1196,7 @@
 		{
 			if (clipEvents != null)
 			{
-				int eventSize = coder.context[FSCoder.Version] &gt; 5 ? 4 : 2;
+				int eventSize = context.version &gt; 5 ? 4 : 2;
 				int eventMask = 0;
 
 				coder.writeWord(0, 2);
@@ -1207,7 +1207,7 @@
 				coder.writeWord(eventMask, eventSize);
 
 				for (Iterator&lt;FSClipEvent&gt; i = clipEvents.iterator(); i.hasNext();)
-					i.next().encode(coder);
+					i.next().encode(coder, context);
 
 				coder.writeWord(0, eventSize);
 			} else
@@ -1215,10 +1215,10 @@
 				coder.writeBytes(encodedEvents);
 			}
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		boolean containsClipEvents = false;
 		boolean containsClippingDepth = false;
@@ -1227,9 +1227,9 @@
 		boolean containsColorTransform = false;
 		boolean containsTransform = false;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
-		coder.context[FSCoder.TransparentColors] = 1;
+		context.transparent = true;
 
 		containsClipEvents = coder.readBits(1, false) != 0 ? true : false;
 		containsClippingDepth = coder.readBits(1, false) != 0 ? true : false;
@@ -1244,10 +1244,10 @@
 			identifier = coder.readWord(2, false);
 
 		if (containsTransform)
-			transform = new FSCoordTransform(coder);
+			transform = new FSCoordTransform(coder, context);
 
 		if (containsColorTransform)
-			colorTransform = new FSColorTransform(coder);
+			colorTransform = new FSColorTransform(coder, context);
 
 		if (containsRatio)
 			ratio = coder.readWord(2, false) / 65535.0f;
@@ -1260,18 +1260,18 @@
 
 		if (containsClipEvents)
 		{
-			int eventSize = coder.context[FSCoder.Version] &gt; 5 ? 4 : 2;
+			int eventSize = context.version &gt; 5 ? 4 : 2;
 			clipEvents = new ArrayList();
 
 			coder.readWord(2, false);
 			coder.readWord(eventSize, false);
 
 			while (coder.scanWord(eventSize, false) != 0)
-				clipEvents.add(new FSClipEvent(coder));
+				clipEvents.add(new FSClipEvent(coder, context));
 
 			coder.readWord(eventSize, false);
 		}
-		coder.context[FSCoder.TransparentColors] = 0;
+		context.transparent = false;
 	}
 
 	private boolean containsTransform()
@@ -1279,7 +1279,7 @@
 		return transform != null;
 	}
 
-	private boolean containsColorTransform(FSCoder coder)
+	private boolean containsColorTransform()
 	{
 		return colorTransform != null;
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSPointer.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSPointer.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSPointer.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -75,10 +75,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSPointer(FSCoder coder)
+	public FSPointer(FSCoder coder, FSContext context)
 	{
 		super(DefineBitsPtr);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -148,23 +148,23 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 		length += 4;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(pointer, 4);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		pointer = coder.readWord(4, false);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSProtect.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSProtect.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSProtect.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -93,10 +93,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSProtect(FSCoder coder)
+	public FSProtect(FSCoder coder, FSContext context)
 	{
 		super(Protect);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** 
@@ -190,9 +190,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		if ((password != null) &amp;&amp; (password.length() &gt; 0))
 			length += 2 + FSCoder.strlen(password, true);
@@ -200,9 +200,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		if ((password != null) &amp;&amp; (password.length() &gt; 0))
 		{
@@ -212,9 +212,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		/*
 		 * Force a read of the entire password field, including any zero bytes

Modified: dev/dev-2-4/src/com/flagstone/transform/FSPush.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSPush.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSPush.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -418,10 +418,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSPush(FSCoder coder)
+	public FSPush(FSCoder coder, FSContext context)
 	{
 		super(Push);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** 
@@ -795,9 +795,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		for (Iterator&lt;Object&gt; i = values.iterator(); i.hasNext();)
 		{
@@ -830,9 +830,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		for (Iterator&lt;Object&gt; i = values.iterator(); i.hasNext();)
 		{
@@ -884,9 +884,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int valuesLength = length;
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSQuicktimeMovie.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSQuicktimeMovie.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSQuicktimeMovie.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -77,10 +77,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSQuicktimeMovie(FSCoder coder)
+	public FSQuicktimeMovie(FSCoder coder, FSContext context)
 	{
 		super(QuicktimeMovie);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -156,25 +156,25 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += FSCoder.strlen(path, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeString(path);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		path = coder.readString();
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSRegisterCopy.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSRegisterCopy.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSRegisterCopy.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -88,10 +88,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSRegisterCopy(FSCoder coder)
+	public FSRegisterCopy(FSCoder coder, FSContext context)
 	{
 		super(RegisterCopy);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -163,24 +163,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(registerNumber, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		registerNumber = coder.readByte();
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSRegisterVariable.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSRegisterVariable.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSRegisterVariable.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -52,9 +52,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSRegisterVariable(FSCoder coder)
+	public FSRegisterVariable(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -166,23 +166,23 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int length = 1;
 
-		length += coder.strlen(name, true);
+		length += FSCoder.strlen(name, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(index, 1);
 		coder.writeString(name);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		index = coder.readByte();
 		name = coder.readString();

Modified: dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -128,10 +128,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSRemoveObject(FSCoder coder)
+	public FSRemoveObject(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.RemoveObject);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -236,24 +236,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 		length += 4;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(identifier, 2);
 		coder.writeWord(layer, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		identifier = coder.readWord(2, false);
 		layer = coder.readWord(2, false);
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSRemoveObject2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -77,10 +77,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSRemoveObject2(FSCoder coder)
+	public FSRemoveObject2(FSCoder coder, FSContext context)
 	{
 		super(RemoveObject2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -155,23 +155,23 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 		length += 2;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(layer, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		layer = coder.readWord(2, false);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSerialNumber.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSerialNumber.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSerialNumber.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -79,10 +79,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSerialNumber(FSCoder coder)
+	public FSSerialNumber(FSCoder coder, FSContext context)
 	{
 		super(SerialNumber);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -158,25 +158,25 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += coder.strlen(serialNumber, true);
+		length += FSCoder.strlen(serialNumber, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeString(serialNumber);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		serialNumber = coder.readString(length - 1);
 		coder.readByte();
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSetBackgroundColor.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSetBackgroundColor.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSetBackgroundColor.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -94,10 +94,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSetBackgroundColor(FSCoder coder)
+	public FSSetBackgroundColor(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.SetBackgroundColor);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -182,24 +182,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += color.length(coder);
+		length += color.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
-		color.encode(coder);
+		super.encode(coder, context);
+		color.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
-		color = new FSColor(coder);
+		super.decode(coder, context);
+		color = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSetTarget.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSetTarget.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSetTarget.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -94,10 +94,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSetTarget(FSCoder coder)
+	public FSSetTarget(FSCoder coder, FSContext context)
 	{
 		super(SetTarget);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -168,26 +168,26 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
-		length += coder.strlen(target, true);
+		length += FSCoder.strlen(target, true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeString(target);
 		coder.writeWord(0, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		target = coder.readString();
 	}
 }
\ No newline at end of file

Modified: dev/dev-2-4/src/com/flagstone/transform/FSShape.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSShape.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSShape.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -72,7 +72,7 @@
 	/*
 	 * This method is only used when lazily decoding shapes.
 	 */
-	FSShape(FSCoder coder, int length)
+	FSShape(FSCoder coder, FSContext context, int length)
 	{
 		/*
 		 * This test is used to overcome a bug in SWFTool's pdf2swf where empty
@@ -81,7 +81,7 @@
 		if (length &gt; 1)
 			encodedObjects = new byte[length];
 
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -91,9 +91,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSShape(FSCoder coder)
+	public FSShape(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** Constructs an FSShape object with no shape objects. */
@@ -238,18 +238,18 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		int numberOfBits = 0;
 
-		coder.context[FSCoder.NumberOfShapeBits] = numberOfBits;
+		context.shapeSize = numberOfBits;
 
 		if (objects != null)
 		{
 			numberOfBits += 8;
 
 			for (Iterator shapeIterator = objects.iterator(); shapeIterator.hasNext();)
-				numberOfBits += ((Codeable) shapeIterator.next()).length(coder);
+				numberOfBits += ((Codeable) shapeIterator.next()).length(context);
 
 			numberOfBits += 6; // Add size of end of shape
 
@@ -261,15 +261,15 @@
 		return numberOfBits &gt;&gt; 3;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		if (objects != null)
 		{
-			coder.writeBits(coder.context[FSCoder.NumberOfFillBits], 4);
-			coder.writeBits(coder.context[FSCoder.NumberOfLineBits], 4);
+			coder.writeBits(context.fillSize, 4);
+			coder.writeBits(context.lineSize, 4);
 
 			for (Iterator shapeIterator = objects.iterator(); shapeIterator.hasNext();)
-				((Codeable) shapeIterator.next()).encode(coder);
+				((Codeable) shapeIterator.next()).encode(coder, context);
 
 			coder.writeBits(0, 6); // End of shape
 			coder.alignToByte();
@@ -279,14 +279,14 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		if (encodedObjects != null)
 		{
 			coder.readBytes(encodedObjects);
 		} else
 		{
-			objects = FSShapeObject.decodeShape(coder);
+			objects = FSShapeObject.decodeShape(coder, context);
 		}
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSShapeObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSShapeObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSShapeObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -37,32 +37,33 @@
 	static ArrayList&lt;FSShapeObject&gt; decodeShape(byte[] bytes)
 	{
 		FSCoder coder = new FSCoder(FSCoder.LITTLE_ENDIAN, bytes);
+		FSContext context = new FSContext();
 
-		return decodeShape(coder);
+		return decodeShape(coder, context);
 	}
 
 	// TODO Can this be optimized
-	static ArrayList&lt;FSShapeObject&gt; decodeShape(FSCoder coder)
+	static ArrayList&lt;FSShapeObject&gt; decodeShape(FSCoder coder, FSContext context)
 	{
 		ArrayList&lt;FSShapeObject&gt; objects = new ArrayList&lt;FSShapeObject&gt;();
 
 		int fillBits = coder.readBits(4, false);
 		int lineBits = coder.readBits(4, false);
 
-		coder.context[FSCoder.NumberOfFillBits] = fillBits;
-		coder.context[FSCoder.NumberOfLineBits] = lineBits;
+		context.fillSize = fillBits;
+		context.lineSize = lineBits;
 
 		while (coder.scanBits(6, false) &gt; 0)
 		{
 			if ((coder.scanBits(6, false) &amp; 0x20) &gt; 0)
 			{
 				if ((coder.scanBits(6, false) &amp; 0x10) &gt; 0)
-					objects.add(new FSLine(coder));
+					objects.add(new FSLine(coder, context));
 				else
-					objects.add(new FSCurve(coder));
+					objects.add(new FSCurve(coder, context));
 			} else
 			{
-				objects.add(new FSShapeStyle(coder));
+				objects.add(new FSShapeStyle(coder, context));
 			}
 		}
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSShapeStyle.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSShapeStyle.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSShapeStyle.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -309,9 +309,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSShapeStyle(FSCoder coder)
+	public FSShapeStyle(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -807,7 +807,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		hasLine = lineStyle &gt;= 0;
 		hasFill = fillStyle &gt;= 0;
@@ -823,11 +823,11 @@
 			numberOfBits += 5 + _moveFieldSize * 2;
 		}
 
-		numberOfBits += hasFill ? coder.context[FSCoder.NumberOfFillBits] : 0;
-		numberOfBits += hasAlt ? coder.context[FSCoder.NumberOfFillBits] : 0;
-		numberOfBits += (hasLine) ? coder.context[FSCoder.NumberOfLineBits] : 0;
+		numberOfBits += hasFill ? context.fillSize : 0;
+		numberOfBits += hasAlt ? context.fillSize : 0;
+		numberOfBits += (hasLine) ? context.lineSize : 0;
 
-		coder.context[FSCoder.NumberOfShapeBits] += numberOfBits;
+		context.shapeSize += numberOfBits;
 
 		if (hasStyles)
 		{
@@ -841,37 +841,37 @@
 			int numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 			int numberOfLineBits = FSCoder.size(lineStyles.size(), false);
 
-			boolean countExtended = coder.context[FSCoder.ArrayCountExtended] != 0;
+			boolean countExtended = context.arrayExtended;
 
 			int numberOfStyleBits = 0;
-			int flushBits = coder.context[FSCoder.NumberOfShapeBits];
+			int flushBits = context.shapeSize;
 
 			numberOfStyleBits += (flushBits % 8 &gt; 0) ? 8 - (flushBits % 8) : 0;
 			numberOfStyleBits += (countExtended &amp;&amp; fillStyles.size() &gt;= 255) ? 24 : 8;
 
 			for (Iterator&lt;FSFillStyle&gt;i = fillStyles.iterator(); i.hasNext();)
-				numberOfStyleBits += i.next().length(coder) * 8;
+				numberOfStyleBits += i.next().length(context) * 8;
 
 			numberOfStyleBits += (countExtended &amp;&amp; lineStyles.size() &gt;= 255) ? 24 : 8;
 
 			for (Iterator&lt;FSLineStyle&gt;i = lineStyles.iterator(); i.hasNext();)
-				numberOfStyleBits += i.next().length(coder) * 8;
+				numberOfStyleBits += i.next().length(context) * 8;
 
 			numberOfStyleBits += 8;
 
-			coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-			coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
-			coder.context[FSCoder.NumberOfShapeBits] += numberOfStyleBits;
+			context.fillSize = numberOfFillBits;
+			context.lineSize = numberOfLineBits;
+			context.shapeSize += numberOfStyleBits;
 
 			numberOfBits += numberOfStyleBits;
 		}
 		return numberOfBits;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		int numberOfFillBits = coder.context[FSCoder.NumberOfFillBits];
-		int numberOfLineBits = coder.context[FSCoder.NumberOfLineBits];
+		int numberOfFillBits = context.fillSize;
+		int numberOfLineBits = context.lineSize;
 
 		coder.writeBits(0, 1);
 		coder.writeBits(hasStyles ? 1 : 0, 1);
@@ -900,7 +900,7 @@
 
 		if (hasStyles)
 		{
-			boolean countExtended = coder.context[FSCoder.ArrayCountExtended] != 0;
+			boolean countExtended = context.arrayExtended;
 
 			coder.alignToByte();
 
@@ -915,7 +915,7 @@
 			}
 
 			for (Iterator&lt;FSFillStyle&gt; i = fillStyles.iterator(); i.hasNext();)
-				i.next().encode(coder);
+				i.next().encode(coder, context);
 
 			if (countExtended &amp;&amp; lineStyles.size() &gt;= 255)
 			{
@@ -928,7 +928,7 @@
 			}
 
 			for (Iterator&lt;FSLineStyle&gt; i = lineStyles.iterator(); i.hasNext();)
-				i.next().encode(coder);
+				i.next().encode(coder, context);
 
 			numberOfFillBits = FSCoder.size(fillStyles.size(), false);
 			numberOfLineBits = FSCoder.size(lineStyles.size(), false);
@@ -937,15 +937,15 @@
 			coder.writeBits(numberOfLineBits, 4);
 
 			// Update the stream with the new numbers of line and fill bits
-			coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-			coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+			context.fillSize = numberOfFillBits;
+			context.lineSize = numberOfLineBits;
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		int numberOfFillBits = coder.context[FSCoder.NumberOfFillBits];
-		int numberOfLineBits = coder.context[FSCoder.NumberOfLineBits];
+		int numberOfFillBits = context.fillSize;
+		int numberOfLineBits = context.lineSize;
 
 		/* shapeType */coder.readBits(1, false);
 		hasStyles = coder.readBits(1, false) != 0 ? true : false;
@@ -974,26 +974,26 @@
 
 			int fillStyleCount = coder.readByte();
 
-			if (coder.context[FSCoder.ArrayCountExtended] != 0 &amp;&amp; fillStyleCount == 0xFF)
+			if (context.arrayExtended &amp;&amp; fillStyleCount == 0xFF)
 				fillStyleCount = coder.readWord(2, false);
 
 			for (int i=0; i&lt;fillStyleCount; i++) {
-				fillStyles.add(FSFillStyle.decodeStyle(coder));
+				fillStyles.add(FSFillStyle.decodeStyle(coder, context));
 			}
 
 			int lineStyleCount = coder.readByte();
 
-			if (coder.context[FSCoder.ArrayCountExtended] != 0 &amp;&amp; lineStyleCount == 0xFF)
+			if (context.arrayExtended &amp;&amp; lineStyleCount == 0xFF)
 				lineStyleCount = coder.readWord(2, false);
 
 			for (int i = 0; i &lt; lineStyleCount; i++)
-				lineStyles.add(new FSLineStyle(coder));
+				lineStyles.add(new FSLineStyle(coder, context));
 
 			numberOfFillBits = coder.readBits(4, false);
 			numberOfLineBits = coder.readBits(4, false);
 
-			coder.context[FSCoder.NumberOfFillBits] = numberOfFillBits;
-			coder.context[FSCoder.NumberOfLineBits] = numberOfLineBits;
+			context.fillSize = numberOfFillBits;
+			context.lineSize = numberOfLineBits;
 		}
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSShowFrame.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSShowFrame.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSShowFrame.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -131,16 +131,16 @@
 	}
 
 	/**
-	 * Construct an FSShowFrame object, initalizing it with values decoded from
+	 * Construct an FSShowFrame object, initalising it with values decoded from
 	 * an encoded object.
 	 * 
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSShowFrame(FSCoder coder)
+	public FSShowFrame(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.ShowFrame);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** Constructs an FSShowFrame object. */
@@ -166,10 +166,10 @@
 		return &quot;FSShowFrame&quot;;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		coder.context[FSCoder.Empty] = 1;
-		super.encode(coder);
-		coder.context[FSCoder.Empty] = 0;
+		context.empty = true;
+		super.encode(coder, context);
+		context.empty = false;
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSolidFill.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSolidFill.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSolidFill.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -137,10 +137,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSolidFill(FSCoder coder)
+	public FSSolidFill(FSCoder coder, FSContext context)
 	{
 		super(FSFillStyle.Solid);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -226,22 +226,22 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		int length = super.length(coder);
-		length += color.length(coder);
+		int length = super.length(context);
+		length += color.length(context);
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
-		color.encode(coder);
+		super.encode(coder, context);
+		color.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
-		color = new FSColor(coder);
+		super.decode(coder, context);
+		color = new FSColor(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSound.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSound.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSound.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -169,9 +169,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSound(FSCoder coder)
+	public FSSound(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -532,7 +532,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		boolean _containsInPoint = containsInPoint();
 		boolean _containsOutPoint = containsOutPoint();
@@ -550,7 +550,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		boolean _containsInPoint = containsInPoint();
 		boolean _containsOutPoint = containsOutPoint();
@@ -575,11 +575,11 @@
 			coder.writeWord(envelopes.size(), 1);
 
 			for (int i = 0; i &lt; envelopes.size(); i++)
-				envelopes.get(i).encode(coder);
+				envelopes.get(i).encode(coder, context);
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		boolean _containsInPoint = false;
 		boolean _containsOutPoint = false;
@@ -611,7 +611,7 @@
 			envelopeCount = coder.readByte();
 
 			for (int i = 0; i &lt; envelopeCount; i++)
-				envelopes.add(new FSEnvelope(coder));
+				envelopes.add(new FSEnvelope(coder, context));
 		}
 	}
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamBlock.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamBlock.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamBlock.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -89,10 +89,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSoundStreamBlock(FSCoder coder)
+	public FSSoundStreamBlock(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.SoundStreamBlock);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -176,24 +176,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += soundData.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeBytes(soundData);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		soundData = new byte[length];
 		coder.readBytes(soundData);
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -175,10 +175,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSoundStreamHead(FSCoder coder)
+	public FSSoundStreamHead(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.SoundStreamHead);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -491,9 +491,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
 
@@ -503,9 +503,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(0, 4);
 
@@ -552,9 +552,9 @@
 			coder.writeWord(latency, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		coder.readBits(4, false);
 		switch (coder.readBits(2, false))

Modified: dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSSoundStreamHead2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -167,10 +167,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSSoundStreamHead2(FSCoder coder)
+	public FSSoundStreamHead2(FSCoder coder, FSContext context)
 	{
 		super(SoundStreamHead2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -491,9 +491,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
 
@@ -503,9 +503,9 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(_reserved, 4);
 
@@ -552,9 +552,9 @@
 			coder.writeWord(latency, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		_reserved = coder.readBits(4, false);
 		switch (coder.readBits(2, false))

Modified: dev/dev-2-4/src/com/flagstone/transform/FSStartSound.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSStartSound.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSStartSound.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -76,10 +76,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSStartSound(FSCoder coder)
+	public FSStartSound(FSCoder coder, FSContext context)
 	{
 		super(FSMovieObject.StartSound);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -165,23 +165,23 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
-		length += sound.length(coder);
+		super.length(context);
+		length += sound.length(context);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
-		sound.encode(coder);
+		super.encode(coder, context);
+		sound.encode(coder, context);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
-		sound = new FSSound(coder);
+		super.decode(coder, context);
+		sound = new FSSound(coder, context);
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSTabOrder.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSTabOrder.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSTabOrder.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -77,10 +77,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSTabOrder(FSCoder coder)
+	public FSTabOrder(FSCoder coder, FSContext context)
 	{
 		super(TabOrder);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -185,26 +185,26 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(layer, 2);
 		coder.writeWord(index, 2);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		layer = coder.readWord(2, false);
 		index = coder.readWord(2, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSTable.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSTable.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSTable.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -130,10 +130,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSTable(FSCoder coder)
+	public FSTable(FSCoder coder, FSContext context)
 	{
 		super(Table);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/** Constructs an empty table. */
@@ -235,21 +235,21 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
 		for (Iterator i = values.iterator(); i.hasNext();)
-			length += coder.strlen((String) i.next(), true);
+			length += FSCoder.strlen((String) i.next(), true);
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(values.size(), 2);
 
@@ -263,9 +263,9 @@
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		int attributeCount = coder.readWord(2, false);
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSText.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSText.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSText.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -262,9 +262,9 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSText(FSCoder coder)
+	public FSText(FSCoder coder, FSContext context)
 	{
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -576,7 +576,7 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
 		boolean _containsFont = containsFont();
 		boolean _containsColor = containsColor();
@@ -588,7 +588,7 @@
 		if (containsStyle())
 		{
 			length += (_containsFont) ? 2 : 0;
-			length += (_containsColor) ? color.length(coder) : 0;
+			length += (_containsColor) ? color.length(context) : 0;
 			length += (_containsOffsetY) ? 2 : 0;
 			length += (_containsOffsetX) ? 2 : 0;
 			length += (_containsFont) ? 2 : 0;
@@ -599,8 +599,8 @@
 		if (characters.size() &gt; 0)
 		{
 			int numberOfBits = 0;
-			int numberOfGlyphBits = coder.context[FSCoder.NumberOfGlyphBits];
-			int numberOfAdvanceBits = coder.context[FSCoder.NumberOfAdvanceBits];
+			int numberOfGlyphBits = context.glyphSize;
+			int numberOfAdvanceBits = context.advanceSize;
 
 			numberOfBits = (numberOfGlyphBits + numberOfAdvanceBits)
 							* characters.size();
@@ -611,7 +611,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		boolean _containsFont = containsFont();
 		boolean _containsColor = containsColor();
@@ -630,7 +630,7 @@
 			coder.writeWord(identifier, 2);
 
 		if (_containsColor)
-			color.encode(coder);
+			color.encode(coder, context);
 
 		if (_containsOffsetX)
 			coder.writeWord(offsetX, 2);
@@ -644,12 +644,12 @@
 		coder.writeWord(characters.size(), 1);
 
 		for (Iterator&lt;FSCharacter&gt; charIter = characters.iterator(); charIter.hasNext();)
-			charIter.next().encode(coder);
+			charIter.next().encode(coder, context);
 
 		coder.alignToByte();
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		/* type */coder.readBits(1, false);
 		/* reserved */coder.readBits(3, false);
@@ -663,7 +663,7 @@
 			identifier = coder.readWord(2, false);
 
 		if (_containsColor)
-			color = new FSColor(coder);
+			color = new FSColor(coder, context);
 
 		if (_containsOffsetX)
 			offsetX = coder.readWord(2, true);
@@ -679,7 +679,7 @@
 		characters = new ArrayList(charCount);
 
 		for (int i = 0; i &lt; charCount; i++)
-			characters.add(new FSCharacter(coder));
+			characters.add(new FSCharacter(coder, context));
 
 		coder.alignToByte();
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSUnknownAction.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSUnknownAction.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSUnknownAction.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -74,10 +74,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSUnknownAction(FSCoder coder)
+	public FSUnknownAction(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -193,9 +193,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		if (data != null) {
 			length += data.length;
@@ -203,18 +203,18 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		
 		if (data != null) {
 			coder.writeBytes(data);
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		if (length &gt; 0)
 		{

Modified: dev/dev-2-4/src/com/flagstone/transform/FSUnknownObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSUnknownObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSUnknownObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -74,10 +74,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSUnknownObject(FSCoder coder)
+	public FSUnknownObject(FSCoder coder, FSContext context)
 	{
 		super(0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -193,9 +193,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		if (data != null) {
 			length += data.length;
@@ -203,18 +203,18 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		
 		if (data != null) {
 			coder.writeBytes(data);
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		if (length &gt; 0)
 		{

Modified: dev/dev-2-4/src/com/flagstone/transform/FSVideo.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSVideo.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSVideo.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -87,7 +87,7 @@
 
 	static final int Codec = 5;
 
-	static FSVideoObject decodeObject(FSCoder coder)
+	static FSVideoObject decodeObject(FSCoder coder, FSContext context)
 	{
 		FSVideoObject currentObject = null;
 
@@ -102,20 +102,20 @@
 		switch (type)
 		{
 			case FSVideoObject.AudioData:
-				currentObject = new FSAudioData(coder);
+				currentObject = new FSAudioData(coder, context);
 				break;
 			case FSVideoObject.VideoData:
-				currentObject = new FSVideoData(coder);
+				currentObject = new FSVideoData(coder, context);
 				break;
 			case FSVideoObject.MetaData:
-				currentObject = new FSVideoMetaData(coder);
+				currentObject = new FSVideoMetaData(coder, context);
 				break;
 			default:
 				break;
 		}
 
 		int delta = next - coder.getPointer();
-		coder.context[FSVideo.Delta] = delta;
+		context.delta = delta;
 		coder.setPointer(next);
 
 		return currentObject;
@@ -290,6 +290,7 @@
 					IOException
 	{
 		FSCoder coder = new FSCoder(FSCoder.BIG_ENDIAN, bytes);
+		FSContext context = new FSContext();
 		FSVideoObject object = null;
 
 		boolean containsAudio = false;
@@ -309,9 +310,9 @@
 
 		do
 		{
-			objects.add(decodeObject(coder));
+			objects.add(decodeObject(coder, context));
 
-			if (coder.context[Delta] != 0)
+			if (context.delta != 0)
 				throw new IOException();
 
 			offset = coder.readWord(4, false);
@@ -354,10 +355,11 @@
 	public byte[] encode() throws IOException
 	{
 		FSCoder coder = new FSCoder(FSCoder.BIG_ENDIAN, 0);
+		FSContext context = new FSContext();
 
-		coder.context[FSVideo.Version] = version;
+		context.version = version;
 
-		int fileLength = length(coder);
+		int fileLength = length(coder, context);
 
 		coder.setData(FSCoder.BIG_ENDIAN, new byte[fileLength]);
 
@@ -384,7 +386,7 @@
 		coder.writeWord(0, 4);
 
 		for (Iterator&lt;FSVideoObject&gt; i = objects.iterator(); i.hasNext();) {
-			FSVideoObject.encode(coder, i.next());
+			FSVideoObject.encode(coder, context, i.next());
 		}
 		return coder.getData();
 	}
@@ -472,13 +474,13 @@
 		return buffer.toString();
 	}
 
-	private int length(FSCoder coder)
+	private int length(FSCoder coder, FSContext context)
 	{
 		int length = 13;
 
 		for (Iterator i = objects.iterator(); i.hasNext();)
 		{
-			length += 4 + ((FSVideoObject) (i.next())).length(coder);
+			length += 4 + ((FSVideoObject) (i.next())).length(context);
 		}
 		return length;
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSVideoData.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSVideoData.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSVideoData.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -81,10 +81,10 @@
 
 	private byte[] data = null;
 
-	FSVideoData(FSCoder coder)
+	FSVideoData(FSCoder coder, FSContext context)
 	{
 		super(FSVideoObject.VideoData, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -237,27 +237,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1 + data.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeBits(codec, 4);
 		coder.writeBits(frameType, 4);
 		coder.writeBytes(data);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		data = new byte[length - 1];
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSVideoFrame.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSVideoFrame.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSVideoFrame.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -96,10 +96,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSVideoFrame(FSCoder coder)
+	public FSVideoFrame(FSCoder coder, FSContext context)
 	{
 		super(VideoFrame);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -245,27 +245,27 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 4 + data.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 
 		coder.writeWord(identifier, 2);
 		coder.writeWord(frameNumber, 2);
 		coder.writeBytes(data);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 
 		data = new byte[length - 4];
 

Modified: dev/dev-2-4/src/com/flagstone/transform/FSVideoMetaData.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSVideoMetaData.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSVideoMetaData.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -41,10 +41,10 @@
 {
 	private byte[] data;
 
-	FSVideoMetaData(FSCoder coder)
+	FSVideoMetaData(FSCoder coder, FSContext context)
 	{
 		super(FSVideoObject.MetaData, 0);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -104,24 +104,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += data.length;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeBytes(data);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		data = new byte[length];
 		coder.readBytes(data);
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSVideoObject.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSVideoObject.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSVideoObject.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -58,13 +58,13 @@
 	/** Type identifying objects containing meta-data */
 	public static final int MetaData = 18;
 	
-	static void encode(FSCoder coder, FSVideoObject object) throws IOException
+	static void encode(FSCoder coder, FSContext context, FSVideoObject object) throws IOException
 	{
 		int length = object.length;
 		int start = coder.getPointer();
 		int next = start + (length &lt;&lt; 3);
 
-		object.encode(coder);
+		object.encode(coder, context);
 		coder.setPointer(next);
 
 		if (((next - coder.getPointer()) &gt;&gt; 3) != 0)
@@ -182,18 +182,18 @@
 		return anObject;
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		coder.context[FSCoder.Type] = type;
+		context.type = type;
 
 		length = 11;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		coder.context[FSCoder.Type] = type;
+		context.type = type;
 
 		coder.writeWord(type, 1);
 		coder.writeWord(length, 3);
@@ -201,7 +201,7 @@
 		coder.writeWord(0, 4);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		type = coder.readByte();
 		length = coder.readWord(3, false);

Modified: dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -115,10 +115,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSWaitForFrame(FSCoder coder)
+	public FSWaitForFrame(FSCoder coder, FSContext context)
 	{
 		super(WaitForFrame);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -222,25 +222,25 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 3;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(frameNumber, 2);
 		coder.writeWord(actionCount, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		frameNumber = coder.readWord(2, false);
 		actionCount = coder.readByte();
 	}

Modified: dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame2.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame2.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSWaitForFrame2.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -114,10 +114,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSWaitForFrame2(FSCoder coder)
+	public FSWaitForFrame2(FSCoder coder, FSContext context)
 	{
 		super(WaitForFrame2);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -189,24 +189,24 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 1;
 
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
-		super.encode(coder);
+		super.encode(coder, context);
 		coder.writeWord(actionCount, 1);
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
-		super.decode(coder);
+		super.decode(coder, context);
 		actionCount = coder.readByte();
 	}
 }

Modified: dev/dev-2-4/src/com/flagstone/transform/FSWith.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/FSWith.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/FSWith.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -111,10 +111,10 @@
 	 * @param coder
 	 *            an FSCoder containing the binary data.
 	 */
-	public FSWith(FSCoder coder)
+	public FSWith(FSCoder coder, FSContext context)
 	{
 		super(With);
-		decode(coder);
+		decode(coder, context);
 	}
 
 	/**
@@ -210,9 +210,9 @@
 		return buffer.toString();
 	}
 
-	public int length(FSCoder coder)
+	public int length(FSContext context)
 	{
-		super.length(coder);
+		super.length(context);
 
 		length += 2;
 
@@ -222,7 +222,7 @@
 		{
 			FSActionObject currentAction = (FSActionObject) i.next();
 
-			actionsLength += currentAction.length(coder);
+			actionsLength += currentAction.length(context);
 			actionsLength += (currentAction.getType() &gt; 128) ? 3 : 1;
 		}
 		length += actionsLength;
@@ -230,7 +230,7 @@
 		return length;
 	}
 
-	public void encode(FSCoder coder)
+	public void encode(FSCoder coder, FSContext context)
 	{
 		coder.writeWord(type, 1);
 		coder.writeWord(length - actionsLength, 2);
@@ -245,27 +245,27 @@
 							+ ((action.getType() &gt; 128) ? 24 : 8);
 			int next = start + (action.getLength() &lt;&lt; 3);
 
-			action.encode(coder);
+			action.encode(coder, context);
 			coder.setPointer(next);
 
 			int delta = (coder.getPointer() - next) &gt;&gt; 3;
 
 			if (delta != 0)
 			{
-				coder.context[FSCoder.CodingError] = 1;
-				coder.context[FSCoder.TypeInError] = action.getType();
-				coder.context[FSCoder.StartOfError] = objStart &gt;&gt;&gt; 3;
-				coder.context[FSCoder.ExpectedLength] = (next - objStart) &gt;&gt;&gt; 3;
-				coder.context[FSCoder.Delta] = delta;
+				context.codingError = true;
+				context.typeInError = action.getType();
+				context.startOfError = objStart &gt;&gt;&gt; 3;
+				context.expectedLength = (next - objStart) &gt;&gt;&gt; 3;
+				context.delta = delta;
 			}
 		}
 	}
 
-	public void decode(FSCoder coder)
+	public void decode(FSCoder coder, FSContext context)
 	{
 		int bytesRead = 0;
 
-		super.decode(coder);
+		super.decode(coder, context);
 
 		actionsLength = coder.readWord(2, false);
 
@@ -275,7 +275,7 @@
 
 		while (bytesRead &lt; actionsLength)
 		{
-			FSActionObject anAction = FSActionObject.decodeAction(coder);
+			FSActionObject anAction = FSActionObject.decodeAction(coder, context);
 
 			bytesRead += anAction.getLength()
 							+ ((anAction.getType() &gt;= 128) ? 3 : 1);

Modified: dev/dev-2-4/src/com/flagstone/transform/test/FSColorTest.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/test/FSColorTest.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/test/FSColorTest.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -141,7 +141,7 @@
         	coder = new FSCoder(FSCoder.LITTLE_ENDIAN, 0);
 
             colour = new FSColor(rgb[i][0], rgb[i][1], rgb[i][2]);
-            colour.encode(coder);
+            colour.encode(coder, context);
 
             assertTrue(coder.equals(initCoder(rgb[i], true)));
             checkColours(colour, rgb[i]);
@@ -153,7 +153,7 @@
             coder.setContext(FSCoder.TransparentColors, 1);
 
             colour = new FSColor(rgba[i][0], rgba[i][1], rgba[i][2], rgba[i][3]);
-            colour.encode(coder);
+            colour.encode(coder, context);
 
             assertTrue(coder.equals(initCoder(rgba[i], true)));
             checkColours(colour, rgba[i]);
@@ -165,7 +165,7 @@
         for (int i=0; i&lt;rgb.length; i++)
         {
             FSCoder coder = initCoder(rgb[i], false);
-            FSColor colour = new FSColor(coder);
+            FSColor colour = new FSColor(coder, context);
 
             assertEquals(coder.getPointer() &gt;&gt; 3, rgb[i].length);
             checkColours(colour, rgb[i]);
@@ -175,7 +175,7 @@
         {
             FSCoder coder = initCoder(rgba[i], false);
             coder.setContext(FSCoder.TransparentColors, 1);
-            FSColor colour = new FSColor(coder);
+            FSColor colour = new FSColor(coder, context);
 
             assertEquals(coder.getPointer() &gt;&gt; 3, rgba[i].length);
             checkColours(colour, rgba[i]);

Modified: dev/dev-2-4/src/com/flagstone/transform/test/FSProtectTest.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/test/FSProtectTest.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/test/FSProtectTest.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -120,8 +120,8 @@
             coder = new FSCoder(FSCoder.LITTLE_ENDIAN, 0);
             obj = new FSProtect(passwords[i]);
            
-            obj.length(coder);
-            obj.encode(coder);
+            obj.length(context);
+            obj.encode(coder, context);
 
             assertTrue(coder.equals(initCoder(encodedObjects[i], true)));
         }
@@ -144,7 +144,7 @@
             if (expectedValue != null &amp;&amp; expectedValue.length() == 0)
                 expectedValue = null;
 
-            FSProtect obj = new FSProtect(coder);
+            FSProtect obj = new FSProtect(coder, context);
 
             assertEquals(coder.getPointer()&gt;&gt;&gt;3, encodedObjects[i].length);
             assertEquals(FSMovieObject.Protect, obj.getType());

Modified: dev/dev-2-4/src/com/flagstone/transform/test/FSSetBackgroundColorTest.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/test/FSSetBackgroundColorTest.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/test/FSSetBackgroundColorTest.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -125,8 +125,8 @@
             coder = new FSCoder(FSCoder.LITTLE_ENDIAN, 0);
             obj = new FSSetBackgroundColor(colours[i]);
             
-            obj.length(coder);
-            obj.encode(coder);
+            obj.length(context);
+            obj.encode(coder, context);
 
             assertTrue(coder.equals(initCoder(encodedObjects[i], true)));
         }
@@ -137,7 +137,7 @@
         for (int i=0; i&lt;encodedObjects.length; i++)
         {
             FSCoder coder = initCoder(encodedObjects[i], false);
-            FSSetBackgroundColor background = new FSSetBackgroundColor(coder);
+            FSSetBackgroundColor background = new FSSetBackgroundColor(coder, context);
 
             assertEquals(coder.getPointer()&gt;&gt;&gt;3, encodedObjects[i].length);
             assertEquals(FSMovieObject.SetBackgroundColor, background.getType());

Modified: dev/dev-2-4/src/com/flagstone/transform/test/FSShowFrameTest.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/test/FSShowFrameTest.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/test/FSShowFrameTest.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -86,8 +86,8 @@
             coder = new FSCoder(FSCoder.LITTLE_ENDIAN, 0);
             obj = new FSShowFrame();
             
-            obj.length(coder);
-            obj.encode(coder);
+            obj.length(context);
+            obj.encode(coder, context);
 
             assertEquals(coder, initCoder(encodedObjects[i], true));
         }
@@ -98,7 +98,7 @@
         for (int i=0; i&lt;encodedObjects.length; i++)
         {
             FSCoder coder = initCoder(encodedObjects[i], false);
-            FSShowFrame obj = new FSShowFrame(coder);
+            FSShowFrame obj = new FSShowFrame(coder, context);
 
             assertEquals(coder.getPointer()&gt;&gt;&gt;3, encodedObjects[i].length);
             assertEquals(FSMovieObject.ShowFrame, obj.getType());

Modified: dev/dev-2-4/src/com/flagstone/transform/util/FSImageConstructor.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/util/FSImageConstructor.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/util/FSImageConstructor.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -1049,9 +1049,9 @@
 
             switch (attributes[COMPRESSION_METHOD])
             {
-                case BI_RGB:  decodeIDX8(coder); break;
-                case BI_RLE8: decodeRLE8(coder); break;
-                case BI_RLE4: decodeRLE4(coder); break;
+                case BI_RGB:  decodeIDX8(coder, context); break;
+                case BI_RLE8: decodeRLE8(coder, context); break;
+                case BI_RLE4: decodeRLE4(coder, context); break;
             }
         }
         else
@@ -1062,14 +1062,14 @@
 
             switch (format)
             {
-                case RGB5: decodeRGB5(coder); break;
-                case RGB8: decodeRGB8(coder); break;
-                case RGBA: decodeRGBA(coder); break;
+                case RGB5: decodeRGB5(coder, context); break;
+                case RGB8: decodeRGB8(coder, context); break;
+                case RGBA: decodeRGBA(coder, context); break;
             }
         }
     }
 
-    private void decodeIDX8(FSCoder coder)
+    private void decodeIDX8(FSCoder coder, FSContext context)
     {
         int h = 0;
         int w = 0;
@@ -1087,7 +1087,7 @@
         }
     }
 
-    private void decodeRLE4(FSCoder coder)
+    private void decodeRLE4(FSCoder coder, FSContext context)
     {
         int row = height-1;
         int col = 0;
@@ -1136,7 +1136,7 @@
         }
     }
     
-    private void decodeRLE8(FSCoder coder)
+    private void decodeRLE8(FSCoder coder, FSContext context)
     {
         int row = height-1;
         int col = 0;
@@ -1181,7 +1181,7 @@
         }
     }
     
-    private void decodeRGB5(FSCoder coder)
+    private void decodeRGB5(FSCoder coder, FSContext context)
     {
         int h = 0;
         int w = 0;
@@ -1237,7 +1237,7 @@
         
     }
 
-    private void decodeRGB8(FSCoder coder)
+    private void decodeRGB8(FSCoder coder, FSContext context)
     {
         int h = 0;
         int w = 0;
@@ -1259,7 +1259,7 @@
         }
     }
 
-    private void decodeRGBA(FSCoder coder)
+    private void decodeRGBA(FSCoder coder, FSContext context)
     {
         int h = 0;
         int w = 0;

Modified: dev/dev-2-4/src/com/flagstone/transform/util/FSSoundConstructor.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/util/FSSoundConstructor.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/util/FSSoundConstructor.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -474,7 +474,7 @@
             switch (chunkType)
             {
                 case FMT: 
-                	decodeFMT(coder); 
+                	decodeFMT(coder, context); 
                 	break;
                 case DATA: 
                 	decodeDATA(coder, length); 
@@ -499,7 +499,7 @@
         }
     }
 
-    private void decodeFMT(FSCoder coder) throws DataFormatException
+    private void decodeFMT(FSCoder coder, FSContext context) throws DataFormatException
     {
         format = FSSound.PCM;
         
@@ -564,7 +564,7 @@
                 if (numberOfFrames == 0)
                     frameStart = coder.getPointer();
                 
-                coder.adjustPointer(MP3FrameSize(coder) &lt;&lt; 3);
+                coder.adjustPointer(MP3FrameSize(coder, context) &lt;&lt; 3);
                 numberOfFrames++;
             }
             else
@@ -664,7 +664,7 @@
         
         while (coder.findBits(0x7FF, 11, 8))
         {
-            coder.adjustPointer(MP3FrameSize(coder) &lt;&lt; 3);
+            coder.adjustPointer(MP3FrameSize(coder, context) &lt;&lt; 3);
             numberOfFrames++;
         }
         
@@ -690,11 +690,11 @@
 
             frameTable[frameNumber++][1] = 4 + (((version == MPEG1) ? 144 : 72) * bitRate*1000 / samplingRate + padding) - 4;
     
-            coder.adjustPointer((MP3FrameSize(coder) &lt;&lt; 3)-23);
+            coder.adjustPointer((MP3FrameSize(coder, context) &lt;&lt; 3)-23);
         }
     }
     
-    private int MP3FrameSize(FSCoder coder)
+    private int MP3FrameSize(FSCoder coder, FSContext context)
     {
         int frameSize = 4;
         

Modified: dev/dev-2-4/src/com/flagstone/transform/util/FSTextConstructor.java
===================================================================
--- dev/dev-2-4/src/com/flagstone/transform/util/FSTextConstructor.java	2008-03-19 10:47:20 UTC (rev 383)
+++ dev/dev-2-4/src/com/flagstone/transform/util/FSTextConstructor.java	2008-03-19 12:16:57 UTC (rev 384)
@@ -1312,18 +1312,18 @@
         
         int bytesRead = 0;
 
-        if (maxpOffset != 0) { coder.setPointer(maxpOffset); decodeMAXP(coder); bytesRead = (coder.getPointer() - maxpOffset) &gt;&gt; 3; }
-        if (os_2Offset != 0) { coder.setPointer(os_2Offset); decodeOS_2(coder); bytesRead = (coder.getPointer() - os_2Offset) &gt;&gt; 3; }
-        if (headOffset != 0) { coder.setPointer(headOffset); decodeHEAD(coder); bytesRead = (coder.getPointer() - headOffset) &gt;&gt; 3; }
-        if (hheaOffset != 0) { coder.setPointer(hheaOffset); decodeHHEA(coder); bytesRead = (coder.getPointer() - hheaOffset) &gt;&gt; 3; }
-        if (nameOffset != 0) { coder.setPointer(nameOffset); decodeNAME(coder); bytesRead = (coder.getPointer() - nameOffset) &gt;&gt; 3; }
+        if (maxpOffset != 0) { coder.setPointer(maxpOffset); decodeMAXP(coder, context); bytesRead = (coder.getPointer() - maxpOffset) &gt;&gt; 3; }
+        if (os_2Offset != 0) { coder.setPointer(os_2Offset); decodeOS_2(coder, context); bytesRead = (coder.getPointer() - os_2Offset) &gt;&gt; 3; }
+        if (headOffset != 0) { coder.setPointer(headOffset); decodeHEAD(coder, context); bytesRead = (coder.getPointer() - headOffset) &gt;&gt; 3; }
+        if (hheaOffset != 0) { coder.setPointer(hheaOffset); decodeHHEA(coder, context); bytesRead = (coder.getPointer() - hheaOffset) &gt;&gt; 3; }
+        if (nameOffset != 0) { coder.setPointer(nameOffset); decodeNAME(coder, context); bytesRead = (coder.getPointer() - nameOffset) &gt;&gt; 3; }
         
         glyphTable = new FSGlyph[numberOfGlyphs];
         
         // Decode glyphs first so objects will be created.
         if (locaOffset != 0) { coder.setPointer(locaOffset); decodeGlyphs(coder, glyfOffset); bytesRead = (coder.getPointer() - locaOffset) &gt;&gt; 3; }
-        if (hmtxOffset != 0) { coder.setPointer(hmtxOffset); decodeHMTX(coder); bytesRead = (coder.getPointer() - hmtxOffset) &gt;&gt; 3; }
-        if (cmapOffset != 0) { coder.setPointer(cmapOffset); decodeCMAP(coder); bytesRead = (coder.getPointer() - cmapOffset) &gt;&gt; 3; }
+        if (hmtxOffset != 0) { coder.setPointer(hmtxOffset); decodeHMTX(coder, context); bytesRead = (coder.getPointer() - hmtxOffset) &gt;&gt; 3; }
+        if (cmapOffset != 0) { coder.setPointer(cmapOffset); decodeCMAP(coder, context); bytesRead = (coder.getPointer() - cmapOffset) &gt;&gt; 3; }
 
         orderTable[0] = characterTable[(short)' '];
         
@@ -1340,7 +1340,7 @@
         glyphTable[spaceIndex].shape = new FSShape();
         glyphTable[spaceIndex].advance = 250;
     }
-    private void decodeHEAD(FSCoder coder)
+    private void decodeHEAD(FSCoder coder, FSContext context)
     {
         byte[] date = new byte[8];
     
@@ -1380,7 +1380,7 @@
         attributes[GLYPH_OFFSET_SIZE] = coder.readWord(2, true); 
         coder.readWord(2, true); // glyph data format
     }
-    private void decodeHHEA(FSCoder coder)
+    private void decodeHHEA(FSCoder coder, FSContext context)
     {
         coder.readFixedBits(32, 16); // table version
     
@@ -1405,7 +1405,7 @@
         
         attributes[NUMBER_OF_METRICS] = coder.readWord(2, false);    
     }
-    private void decodeOS_2(FSCoder coder)
+    private void decodeOS_2(FSCoder coder, FSContext context)
     {
         byte[] panose = new byte[10];
         int[] unicodeRange = new int[4];
@@ -1472,7 +1472,7 @@
             }
         }
     }
-    private void decodeNAME(FSCoder coder)
+    private void decodeNAME(FSCoder coder, FSContext context)
     {
     	int stringTableBase = coder.getPointer() &gt;&gt;&gt; 3;
     	
@@ -1529,7 +1529,7 @@
             coder.setPointer(current);
         }
     }
-    private void decodeMAXP(FSCoder coder)
+    private void decodeMAXP(FSCoder coder, FSContext context)
     {
         float version = coder.readFixedBits(32, 16);
         numberOfGlyphs = coder.readWord(2, false);
@@ -1551,7 +1551,7 @@
             coder.readWord(2, false); // maximum level of recursion
         }
     }
-    private void decodeHMTX(FSCoder coder)
+    private void decodeHMTX(FSCoder coder, FSContext context)
     {
         int i = 0;
         
@@ -1569,7 +1569,7 @@
         for (; i&lt;numberOfGlyphs; i++)
             coder.readWord(2, true);
     }
-    private void decodeCMAP(FSCoder coder)
+    private void decodeCMAP(FSCoder coder, FSContext context)
     {
         int tableStart = coder.getPointer();
         


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000319.html">[Transform-svn] r383 - in dev/dev-2-4/src/com/flagstone/transform:	. test util
</A></li>
	<LI>Next message: <A HREF="000329.html">[Transform-svn] r385 - in dev/dev-2-4/src/com/flagstone/transform:	. test util
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#320">[ date ]</a>
              <a href="thread.html#320">[ thread ]</a>
              <a href="subject.html#320">[ subject ]</a>
              <a href="author.html#320">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/transform-svn">More information about the Transform-svn
mailing list</a><br>
</body></html>
